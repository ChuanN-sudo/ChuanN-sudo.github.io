<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ä½¿ç”¨marpç”Ÿæˆppt</title>
    <link href="/2026/01/01/%E4%BD%BF%E7%94%A8marp%E7%94%9F%E6%88%90ppt/"/>
    <url>/2026/01/01/%E4%BD%BF%E7%94%A8marp%E7%94%9F%E6%88%90ppt/</url>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æœ€è¿‘ç”±äºé¡¹ç›®å’Œè‡ªå·±æ•´çš„ä¸€äº›å°ç©æ„çš„è¦æ±‚ï¼Œéœ€è¦é¢‘ç¹åšpptï¼Œä½†æ˜¯ç¬”è€…åˆæ²¡ä»€ä¹ˆå®¡ç¾ï¼Œåšå‡ºæ¥çš„å¾ˆéš¾çœ‹ï¼Œæ ¼å¼åå¤æ”¹ï¼Œç»å¸¸å‡ºç°ä¸€ä¸ªPPTåšä¸¤å¤©çš„æƒ…å†µğŸ˜­ã€‚è€Œæˆ‘è‡ªå·±å®¡ç¾æœ¬èº«å°±æ˜¯ä¸€å¨ï¼Œç»å¸¸å‡ºç°æ”¹äº†å¥½å‡ å¤©è¿˜æ˜¯å¾ˆä¸‘ã€‚</p><p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•æŠŠæˆ‘ä»¬ä»è¿™ç§çŠ¶å†µä¸‹è§£æ•‘å‡ºæ¥å‘¢ğŸ§ï¼Œæºœgithubçš„æ—¶å€™çœ‹åˆ°äº†è¿™ä¸ªç©æ„ï¼š<a href="https://github.com/marp-team/marp">marp</a></p><p><img src="/2026/01/01/%E4%BD%BF%E7%94%A8marp%E7%94%9F%E6%88%90ppt/image-20260102193815610.png" alt="marp GitHubé¡µé¢"></p><p>å¾ˆå¥½ï¼Œå†™markdownè¿™æ´»æˆ‘å¾ˆç†Ÿäº†ã€‚æ­£å·§è¿™ç©æ„è¿˜æœ‰å¯¹åº”çš„VS Codeæ’ä»¶ï¼š</p><p><img src="/2026/01/01/%E4%BD%BF%E7%94%A8marp%E7%94%9F%E6%88%90ppt/image-20260102193928665.png" alt="Marp for VS Code"></p><h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>æˆ‘ä»¬åœ¨VS codeé‡Œé¢å†™å‡ è¡Œå°ä»£ç ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs markdown">---<br>marp: true<br>title: ä¸ªäººæ±‡æŠ¥<br>paginate: true<br><span class="hljs-section">theme: uncover</span><br><span class="hljs-section">---</span><br><span class="hljs-section"># XXX å·¥ä½œæ±‡æŠ¥</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span></span><br><br><span class="hljs-bullet">-</span> æ±‡æŠ¥äººï¼šChuann<br><span class="hljs-section">- æ—¥æœŸï¼š2025-1-2</span><br><span class="hljs-section">---</span><br><span class="hljs-section">## å·¥ä½œæ€»è§ˆ</span><br><span class="hljs-bullet">-</span> æ–¹å‘ï¼šè´Ÿè´£XXXXX çš„XXXXXå·¥ä½œ<br><span class="hljs-bullet">-</span> ä¸»è¦å·¥ä½œï¼š<br><span class="hljs-bullet">  -</span> XXXé¡¹ç›®ç¡¬ä»¶ç”µè·¯é—®é¢˜æ’æŸ¥<br><span class="hljs-bullet">  -</span> XXXXå®éªŒæ–¹æ¡ˆè®¾è®¡<br><span class="hljs-bullet">  -</span> ä¸ºXXXæ¨¡å—æ–°å¢äº†XXXXåŠŸèƒ½<br><br>---<br><span class="hljs-section"># <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">big</span>&gt;</span></span><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">center</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;font-size: 200px;&quot;</span>&gt;</span></span> è°¢è°¢ï¼<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">center</span>&gt;</span></span><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">big</span>&gt;</span></span></span><br>&lt;!---<br>è°¢è°¢å¤§å®¶ã€‚<br>---&gt;<br></code></pre></td></tr></table></figure><p>ä»£ç é‡Œé¢ï¼Œ<code>---</code>æ˜¯pptçš„åˆ†é¡µå‘½ä»¤ï¼Œå¼€å¤´æ˜¯ä¸€äº›é…ç½®è®¾ç½®ï¼Œä¸»é¢˜ä»€ä¹ˆçš„ï¼Œå…¶ä»–å†™æ³•å’Œmarkdownä¸€æ ·ï¼Œä¹Ÿæ”¯æŒåµŒå…¥htmlè¯­æ³•ã€‚</p><p>ç„¶åæˆ‘ä»¬ç‚¹è¿™ä¸ªæŒ‰é’®ï¼Œæ‰“å¼€å®æ—¶é¢„è§ˆï¼š</p><p><img src="/2026/01/01/%E4%BD%BF%E7%94%A8marp%E7%94%9F%E6%88%90ppt/image-20260102195553136.png" alt="æ‰“å¼€å®æ—¶é¢„è§ˆ"></p><p>å³ä¾§å°±èƒ½çœ‹åˆ°å®æ—¶æ¸²æŸ“çš„pptäº†</p><p><img src="/2026/01/01/%E4%BD%BF%E7%94%A8marp%E7%94%9F%E6%88%90ppt/image-20260102195641735.png" alt="å®æ—¶æ¸²æŸ“ppt"></p><p>æ¯”å¦‚æˆ‘ç”¨htmlè¯­æ³•å¡ä¸€å¼ å›¾ç‰‡è¿›å»(markdownè‡ªå·±çš„å›¾ç‰‡æ’å…¥è¯­æ³•ä¹Ÿè¡Œï¼Œä½†æˆ‘ç”¨htmlå¤šä¸€äº›)ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><br><span class="hljs-section">## å·¥ä½œæ€»è§ˆ</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;image.png&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;400&quot;</span> <span class="hljs-attr">align</span>=<span class="hljs-string">&quot;right&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;margin-right: 20px;&quot;</span>&gt;</span></span><br><br><span class="hljs-bullet">-</span> æ–¹å‘ï¼šè´Ÿè´£XXXXX çš„XXXXXå·¥ä½œ<br><span class="hljs-bullet">-</span> ä¸»è¦å·¥ä½œï¼š<br><span class="hljs-bullet">  -</span> XXXé¡¹ç›®ç¡¬ä»¶ç”µè·¯é—®é¢˜æ’æŸ¥<br><span class="hljs-bullet">  -</span> XXXXå®éªŒæ–¹æ¡ˆè®¾è®¡<br><span class="hljs-bullet">  -</span> ä¸ºXXXæ¨¡å—æ–°å¢äº†XXXXåŠŸèƒ½<br><br></code></pre></td></tr></table></figure><p>æ¸²æŸ“å‡ºæ¥æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="/2026/01/01/%E4%BD%BF%E7%94%A8marp%E7%94%9F%E6%88%90ppt/image-20260102201751836.png" alt="æ’å…¥å›¾ç‰‡"></p><p>åŸºæœ¬çš„ç”¨æ³•å°±æ˜¯è¿™ç§ï¼Œè¿™ä¹ˆçœ‹ï¼Œç”¨marpè¿˜æ˜¯è¦å†™ä»£ç ï¼Œå¯¹äºä¸ç†Ÿæ‚‰markdownçš„æœ‹å‹å¹¶ä¸å‹å¥½ğŸ¤”ã€‚ä½†æ˜¯ç¬”è€…è®¤ä¸ºmarpè¿™é‡Œä»£ç ç”Ÿæˆpptçš„å·¥å…·ï¼Œå…¶æœ€å¤§ä»·å€¼ä¸»è¦æ˜¯å¯ä»¥ä½¿ç”¨aiç”Ÿæˆäº†ï¼Œæµç¨‹ç†Ÿæ‚‰ä»¥åæŠ½AIé­å­å°±è¡Œäº†ğŸ¤“ã€‚</p><h3 id="è¿›é˜¶ç”¨æ³•"><a href="#è¿›é˜¶ç”¨æ³•" class="headerlink" title="è¿›é˜¶ç”¨æ³•"></a>è¿›é˜¶ç”¨æ³•</h3><p>å¾…ç»­ï¼Œåç»­ä¼šè¡¥å……è‡ªå®šä¹‰ä¸»é¢˜ä»¥åŠå¯¼å…¥ä¸»é¢˜ï¼Œè®¾ç½®èƒŒæ™¯ç­‰ç”¨æ³•</p>]]></content>
    
    
    <categories>
      
      <category>å¦™å¦™å·¥å…·</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è‡ªåŠ¨åŒ–</tag>
      
      <tag>ppt</tag>
      
      <tag>å¦™å¦™å·¥å…·</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>cuda-tile ç®€æ</title>
    <link href="/2025/12/28/cuda-tile-%E7%AE%80%E6%9E%90/"/>
    <url>/2025/12/28/cuda-tile-%E7%AE%80%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>Nvidiaå¼€æºäº†<a href="https://github.com/NVIDIA/cuda-tile">cuda-tile</a>ï¼Œæ­£å¥½å†™ä¸€ä¸ªæŠ€æœ¯åšå®¢çœ‹çœ‹å®ç°ç»†èŠ‚ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CUDA</tag>
      
      <tag>AI</tag>
      
      <tag>GPU</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>K230-GNNEé©±åŠ¨ç§»æ¤</title>
    <link href="/2025/12/25/K230-GNNE%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/"/>
    <url>/2025/12/25/K230-GNNE%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/</url>
    
    <content type="html"><![CDATA[<h2 id="ç¡¬ä»¶å¹³å°"><a href="#ç¡¬ä»¶å¹³å°" class="headerlink" title="ç¡¬ä»¶å¹³å°"></a>ç¡¬ä»¶å¹³å°</h2><p>K230æ¶æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="/2025/12/25/K230-GNNE%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/image-20251226114205250.png" alt="K230æ¶æ„"></p><p>é»„æ¡†æ˜¯AI Subsystemï¼Œé‡Œé¢åŒ…å«äº†KPUã€AI2Dã€FFTä»¥åŠSRAMï¼Œè¿™é‡Œæˆ‘ä»¬åªè€ƒè™‘KPUå’ŒAI2Dã€‚</p><h3 id="GNNE"><a href="#GNNE" class="headerlink" title="GNNE"></a>GNNE</h3><p>GNNEï¼Œæˆ–è€…å«KPUï¼Œè¿™ä¸¤ä¸ªåœ¨å˜‰æ¥ æ‰‹å†Œçš„Memory Mapä¸­æ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œä¹Ÿå°±æ˜¯æ˜¯åŒä¸€ä¸ªå¤–è®¾ã€‚</p><p>KPUç”¨äºå®ç°ç¥ç»ç½‘ç»œç®—å­ï¼ŒK230çš„KPUç›®å‰æ”¯æŒï¼šint8å’Œint16çš„å·ç§¯ã€æ± åŒ–ï¼ŒLSTMï¼ŒRELUç­‰ç®—å­ä»¥åŠä¸€äº›çŸ©é˜µè¿ç®—ã€‚ä½†æ˜¯Solfmaxç­‰ç®—å­è¿˜æ˜¯å¾—äº¤ç»™CPUè¿›è¡Œè®¡ç®—ã€‚å…·ä½“æ”¯æŒç®—å­è¯¦è§ï¼š<a href="https://kendryte-download.canaan-creative.com/developer/k230/HDK/K230%E7%A1%AC%E4%BB%B6%E6%96%87%E6%A1%A3/K230_Technical_Reference_Manual_V0.3.1_20241118.pdf">K230æŠ€æœ¯å‚è€ƒæ‰‹å†Œ</a>4.2 Function Descriptionéƒ¨åˆ†ã€‚</p><h3 id="AI2D"><a href="#AI2D" class="headerlink" title="AI2D"></a>AI2D</h3><p>AI2Dæ¨¡å—ä¸»è¦è¿›è¡Œå›¾åƒå¤„ç†ï¼Œå¯ä»¥å¯¹æ¥è‡ªCPUæˆ–è€…KPUçš„æ•°æ®è¿›è¡Œç¼©æ”¾ã€ä»¿å°„å˜åŒ–ã€è£å‰ªã€å¡«å……ç­‰ã€‚</p><h2 id="é©±åŠ¨æ¶æ„è®¾è®¡"><a href="#é©±åŠ¨æ¶æ„è®¾è®¡" class="headerlink" title="é©±åŠ¨æ¶æ„è®¾è®¡"></a>é©±åŠ¨æ¶æ„è®¾è®¡</h2><p>æŸ¥é˜…<a href="https://kendryte-download.canaan-creative.com/developer/k230/HDK/K230%E7%A1%AC%E4%BB%B6%E6%96%87%E6%A1%A3/K230_Technical_Reference_Manual_V0.3.1_20241118.pdf">K230æŠ€æœ¯å‚è€ƒæ‰‹å†Œ</a>ï¼Œä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå˜‰æ¥ å¹¶æ²¡æœ‰æä¾›KPUçš„å¯„å­˜å™¨æ‰‹å†Œï¼Œå’Œå·¥ç¨‹å¸ˆæ²Ÿé€šåï¼Œäº†è§£åˆ°GNNEçš„é©±åŠ¨åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†åŒ…å«é”ä»¥åŠè½®è¯¢ç­‰å¾…ï¼Œå¦ä¸€éƒ¨åˆ†ç”±NNCASEå®ç°ï¼Œç›´æ¥åœ¨ç”¨æˆ·æ€è¿›è¡ŒIOå†…å­˜æ˜ å°„ã€‚å› æ­¤ï¼Œæƒ³å®Œæˆåœ¨K230ä¸Šè¿è¡Œyoloä¹‹ç±»çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œéœ€è¦ä¸‰éƒ¨åˆ†ï¼šNNCASEã€MMZé©±åŠ¨ã€GNNEï¼ˆKPU+AI2Dï¼‰é©±åŠ¨ã€‚</p><h3 id="NNCASE"><a href="#NNCASE" class="headerlink" title="NNCASE"></a>NNCASE</h3><p>NNCASEæ˜¯å˜‰æ¥ å¼€å‘çš„ç¥ç»ç½‘ç»œç¼–è¯‘å™¨ï¼Œæ”¯æŒCPUå’ŒKPUï¼ŒAI2Dä½œä¸ºä¸€ä¸ªå­æ¨¡å—åŒ…å«åœ¨é‡Œé¢çš„ã€‚nncaseå¤§è‡´åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ç¼–è¯‘å™¨compilerå’Œruntimeã€‚</p><p>ç”±äºç¬”è€…åœ¨é©±åŠ¨ç§»æ¤è¿‡ç¨‹ä¸­ä¸»è¦è´Ÿè´£bspéƒ¨åˆ†ï¼Œnncaseå¹¶æ²¡æœ‰æ·±å…¥ç ”ç©¶ï¼Œä½¿ç”¨æ–¹æ³•è¯¦è§ï¼š<a href="https://www.kendryte.com/k230/dev/01_software/board/ai/K230_nncase_%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97.html">K230 nncaseå¼€å‘æŒ‡å—</a>ï¼Œå˜‰æ¥ é•œåƒä¸­ä¹Ÿæœ‰è®¾è®¡å¥½çš„çš„demoï¼š<a href="https://www.kendryte.com/k230_rtos/zh/main/app_develop_guide/ai/index.html">AI åº”ç”¨å¼€å‘</a>ï¼Œåœ¨<code>menuconfig</code>ä¸­<code>K230 SDK Project Configuration -&gt;RT-Smart Configuration -&gt; Enable build Rtsmart examples</code>ä¸­å‹¾é€‰å³å¯ï¼š</p><p><img src="/2025/12/25/K230-GNNE%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/image-20251226173937361.png" alt="å˜‰æ¥ é•œåƒä½¿èƒ½ai demo"></p><p>çƒ§å½•åè¿›å…¥ç³»ç»Ÿï¼Œ<code>cd app/examples</code>è¿›å…¥å·¥ç¨‹ç›®å½•æ‰§è¡Œå¯¹åº”å†ç¨‹çš„è„šæœ¬æˆ–è€…elfå³å¯ã€‚</p><h3 id="MMZé©±åŠ¨"><a href="#MMZé©±åŠ¨" class="headerlink" title="MMZé©±åŠ¨"></a>MMZé©±åŠ¨</h3><p>é©±åŠ¨å†™å¥½åï¼Œç›´æ¥è¿è¡Œdemoä¼šæŠ¥ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é”™è¯¯ï¼š</p><p><img src="/2025/12/25/K230-GNNE%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/image-20251226174641753.png" alt="image-20251226174641753"></p><p>å¤§è‡´åŸå› ä¼¼ä¹æ˜¯<code>gp</code>æŒ‡é’ˆä¸º0ï¼Œç„¶åæœ‰ä¸€ä¸ª<code>gp-0x800</code>çš„å¯»å€ï¼Œå¯¼è‡´æŒ‡å‘äº†0xfffffffffffff800è¿™ä¸ªå†…æ ¸ç©ºé—´ï¼Œå¹¶ä¸æ˜¯é©±åŠ¨æŠ¥é”™ã€‚</p><p>å’Œå˜‰æ¥ å·¥ç¨‹å¸ˆæ²Ÿé€šåï¼Œå‘ç°ç¼ºå°‘ä¸€ä¸ªmmzé©±åŠ¨ï¼Œå…·ä½“åœ¨è¿™é‡Œï¼š<a href="https://github.com/canmv-k230/mpp">mppé©±åŠ¨</a>ï¼Œmmzæ˜¯æ•´ä¸ªé©±åŠ¨ä¸‹é¢çš„ä¸€ä¸ªå­æ¨¡å—ã€‚mmzé©±åŠ¨å¹¶æ²¡å¼€æºï¼Œå˜‰æ¥ æä¾›çš„æ˜¯ä¸€ä¸ªé™æ€åº“ï¼Œç®€å•çœ‹äº†ä¸€ä¸‹mmzçš„ä½¿ç”¨demoï¼š</p><p>é©±åŠ¨çš„ä½œç”¨æ˜¯åˆ†é…éç¼“å­˜å†…å­˜ä»¥åŠå¸¦ç¼“å­˜çš„å†…å­˜ï¼Œä»¥åŠç‰©ç†&#x2F;è™šæ‹Ÿåœ°å€æ˜ å°„ã€‚å¤§è‡´çŒœæµ‹äº†ä¸€ä¸‹nncaseä¸ºä»€ä¹ˆä¼šå¯¹mmzæœ‰ä¾èµ–ï¼š</p><ul><li>ç¡¬ä»¶åŠ é€Ÿå™¨ï¼ˆGNNEã€AI2Dï¼‰éœ€è¦ç‰©ç†åœ°å€è¿›è¡Œ DMA ä¼ è¾“</li><li>éœ€è¦å¤§å—è¿ç»­ç‰©ç†å†…å­˜</li><li>ç”¨æˆ·ç©ºé—´å’Œç¡¬ä»¶ä¹‹é—´é›¶æ‹·è´å…±äº«æ•°æ®</li><li>NNCASEéœ€è¦åœ¨ç”¨æˆ·æ€è¿›è¡Œioå†…å­˜æ˜ å°„</li></ul><h3 id="GNNE-KPU-é©±åŠ¨"><a href="#GNNE-KPU-é©±åŠ¨" class="headerlink" title="GNNE(KPU)é©±åŠ¨"></a>GNNE(KPU)é©±åŠ¨</h3><p>ä¹‹å‰æåˆ°ï¼Œå…·ä½“çš„ç®—å­å®ç°ä»¥åŠå†…å­˜åˆ†é…ç”±NNCASEå’ŒMMZå®ç°äº†ï¼Œåœ¨GNNEé©±åŠ¨ä¸­ï¼Œåªéœ€è¦å®ç°é˜»å¡å’Œé”ä»¥åŠä¸­æ–­å°±è¡Œäº†ã€‚æ‰€ä»¥ï¼Œå¯¹äºGNNEå’ŒAI2Dé©±åŠ¨çš„opsï¼Œéœ€è¦æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼š<code>open</code>ã€<code>close</code>ã€<code>poll</code>ã€<code>control</code>ï¼Œä»”ç»†çœ‹rttè®¾å¤‡å­ç³»ç»Ÿçš„ç»“æ„ä½“**<code>rt_device_ops</code>**ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_device_ops</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/* common device interface */</span><br>    <span class="hljs-type">rt_err_t</span>  (*init)   (<span class="hljs-type">rt_device_t</span> dev);<br>    <span class="hljs-type">rt_err_t</span>  (*open)   (<span class="hljs-type">rt_device_t</span> dev, <span class="hljs-type">rt_uint16_t</span> oflag);<br>    <span class="hljs-type">rt_err_t</span>  (*close)  (<span class="hljs-type">rt_device_t</span> dev);<br>    <span class="hljs-type">rt_ssize_t</span> (*read)  (<span class="hljs-type">rt_device_t</span> dev, <span class="hljs-type">rt_off_t</span> pos, <span class="hljs-type">void</span> *buffer, <span class="hljs-type">rt_size_t</span> size);<br>    <span class="hljs-type">rt_ssize_t</span> (*write) (<span class="hljs-type">rt_device_t</span> dev, <span class="hljs-type">rt_off_t</span> pos, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buffer, <span class="hljs-type">rt_size_t</span> size);<br>    <span class="hljs-type">rt_err_t</span>  (*control)(<span class="hljs-type">rt_device_t</span> dev, <span class="hljs-type">int</span> cmd, <span class="hljs-type">void</span> *args);<br>&#125;;<br></code></pre></td></tr></table></figure><p>æœ‰<code>open</code>ï¼Œ<code>close</code>ï¼Œ<code>control</code>ï¼Œä½†æ˜¯æ²¡æœ‰<code>poll</code>ï¼Œæ‰€ä»¥æŠŠGNNEå½“ä½œä¸€ä¸ªè®¾å¤‡å­ç³»ç»Ÿæ³¨å†Œï¼Œ<code>dfs_file_ops</code>æ°å¥½èƒ½æ»¡è¶³è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dfs_file_ops</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span> (*open)(<span class="hljs-keyword">struct</span> dfs_file *file);<br>    <span class="hljs-type">int</span> (*close)(<span class="hljs-keyword">struct</span> dfs_file *file);<br>    <span class="hljs-type">int</span> (*ioctl)(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-type">int</span> cmd, <span class="hljs-type">void</span> *arg);<br>    <span class="hljs-type">ssize_t</span> (*read)(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> count, <span class="hljs-type">off_t</span> *pos);<br>    <span class="hljs-type">ssize_t</span> (*write)(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> count, <span class="hljs-type">off_t</span> *pos);<br>    <span class="hljs-type">int</span> (*flush)(<span class="hljs-keyword">struct</span> dfs_file *file);<br>    <span class="hljs-type">off_t</span> (*lseek)(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-type">off_t</span> offset, <span class="hljs-type">int</span> wherece);<br>    <span class="hljs-type">int</span> (*truncate)(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-type">off_t</span> offset);<br>    <span class="hljs-type">int</span> (*getdents)(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-keyword">struct</span> dirent *dirp, <span class="hljs-type">uint32_t</span> count);<br>    <span class="hljs-type">int</span> (*poll)(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-keyword">struct</span> rt_pollreq *req);<br><br>    <span class="hljs-type">int</span> (*mmap)(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-keyword">struct</span> lwp_avl_struct *mmap);<br>    <span class="hljs-type">int</span> (*lock)(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-keyword">struct</span> file_lock *flock);<br>    <span class="hljs-type">int</span> (*flock)(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-type">int</span>, <span class="hljs-keyword">struct</span> file_lock *flock);<br>&#125;;<br></code></pre></td></tr></table></figure><p> dfsæ–‡ä»¶ç³»ç»Ÿçš„opsæä¾›äº†<code>ioctl</code>å¯ä»¥å®ç°ç¡¬ä»¶å±‚é¢çš„é”ï¼Œ<code>poll</code>å¯ä»¥å®ç°é˜»å¡ç­‰å¾…ï¼Œå› æ­¤ï¼ŒGNNEè¢«å½“ä½œä¸€ä¸ªæ–‡ä»¶æ³¨å†Œé©±åŠ¨ã€‚</p><h2 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h2><p>GNNEå’ŒAI2Dçš„é©±åŠ¨åŸºæœ¬å®Œå…¨ç›¸åŒï¼Œè™½ç„¶K230æ‰‹å†Œä¸­æä¾›äº†AI2Dæ¨¡å—çš„å¯„å­˜å™¨ï¼Œä½†æ˜¯äº‹å®ä¸ŠAI2Dçš„å†…å­˜æ˜ å°„è¿˜æ˜¯åœ¨NNCASEä¸­å®Œæˆçš„ï¼Œé©±åŠ¨åªæ˜¯æä¾›é˜»å¡å’Œé”ç­‰ç­‰ã€‚ç”±äºAI2Dçš„å®ç°å’ŒGNNEåŸºæœ¬å®Œå…¨ä¸€è‡´ï¼Œè¿™é‡Œä¸å†è®¨è®ºã€‚</p><h3 id="GNNEé©±åŠ¨å®ç°"><a href="#GNNEé©±åŠ¨å®ç°" class="headerlink" title="GNNEé©±åŠ¨å®ç°"></a>GNNEé©±åŠ¨å®ç°</h3><p>é¦–å…ˆéœ€è¦åœ¨é©±åŠ¨é‡Œå®ç°<code>dfs_files_ops</code>è¿™ä¸ªç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dfs_file_ops</span> <span class="hljs-title">gnne_input_fops</span> =</span><br>&#123;<br>    .open = gnne_device_open,<br>    .close = gnne_device_close,<br>    .ioctl = gnne_device_ioctl,<br>    .poll = gnne_device_poll,<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>gnne_device_open</code>å‡½æ•°ç”¨äºä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºç‹¬ç«‹çš„å¥æŸ„ï¼Œè·å–è®¾å¤‡å¯¹è±¡å¹¶ä¿å­˜é˜Ÿåˆ—ç­‰å¾…æŒ‡é’ˆï¼Œåˆå§‹åŒ–é”çŠ¶æ€ä¸ºæœªé”å®šï¼Œåˆå§‹åŒ–é”ï¼Œæœ€åå°†å¥æŸ„ç»‘å®šåˆ°æ–‡ä»¶æè¿°ç¬¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">gnne_device_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dfs_file *file)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gnne_dev_handle</span> *<span class="hljs-title">handle</span>;</span><br>    <span class="hljs-type">rt_device_t</span> device;<br><br>    handle = rt_malloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> gnne_dev_handle));<br>    <span class="hljs-keyword">if</span> (handle == RT_NULL)<br>    &#123;<br>        gnne_err(<span class="hljs-string">&quot;malloc failed\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    device = (<span class="hljs-type">rt_device_t</span>)file-&gt;vnode-&gt;data;<br>    handle-&gt;wait = &amp;device-&gt;wait_queue;<br>    handle-&gt;is_lock = RT_FALSE;<br>    file-&gt;data = (<span class="hljs-type">void</span> *)handle;<br>    <span class="hljs-keyword">return</span> RT_EOK;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>gnne_dev_handle</code>ç»“æ„ä½“æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œ<code>is_lock</code>æ˜¯é”ï¼Œè€Œ<code>wait</code>æ˜¯é˜»å¡ç­‰å¾…é˜Ÿåˆ—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gnne_dev_handle</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">rt_wqueue_t</span> *wait;<br>    <span class="hljs-type">rt_bool_t</span> is_lock;<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>gnne_device_close</code>å‡½æ•°ç”¨äºè®¾å¤‡çš„å…³é—­ï¼Œåœ¨ç”¨æˆ·ç©ºé—´è°ƒç”¨ <code>close(fd)</code> æ—¶è¢«è§¦å‘ï¼Œè´Ÿè´£æ¸…ç†èµ„æºå¹¶é‡Šæ”¾ç¡¬ä»¶é”ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">gnne_device_close</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dfs_file *file)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gnne_dev_handle</span> *<span class="hljs-title">handle</span>;</span><br><br>    handle = (<span class="hljs-keyword">struct</span> gnne_dev_handle *)file-&gt;data;<br>    <span class="hljs-keyword">if</span> (handle == RT_NULL)<br>    &#123;<br>        gnne_err(<span class="hljs-string">&quot;try to close a invalid handle&quot;</span>);<br>        <span class="hljs-keyword">return</span> -RT_EINVAL;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (handle-&gt;is_lock)<br>    &#123;<br>        kd_hardlock_unlock(g_kpu_lock);<br>    &#125;<br>    rt_free(handle);<br>    file-&gt;data = RT_NULL;<br>    <span class="hljs-keyword">return</span> RT_EOK;<br>&#125;<br></code></pre></td></tr></table></figure><p>é”çš„å®ç°åœ¨<code>gnne_device_ioctl</code>ä¸­ï¼Œç”¨æˆ·ç©ºé—´é€šè¿‡å¯¹<code>ioctl()</code> çš„è°ƒç”¨ï¼Œå®ç° GNNE ç¡¬ä»¶çš„è®¿é—®æ§åˆ¶ã€‚GNNEé©±åŠ¨çš„é”æ§åˆ¶æœ‰ä¸‰ç§æ¨¡å¼ï¼š<code>GNNE_CMD_LOCK</code>ç”¨äºå®ç°è‡ªæ—‹é”ï¼Œ<code>GNNE_CMD_UNLOCK</code>å®ç°å¯¹ç¡¬ä»¶çš„è§£é”ï¼Œè€Œ<code>GNNE_CMD_TRYLOCK</code>åªå°è¯•å°è¯•ä¸€æ¬¡ä¸Šé”ï¼Œå¹¶ä¸è¿›è¡Œè‡ªæ—‹ï¼Œæ‰€æœ‰çš„é”å®ç°åï¼ŒæŠŠå€¼èµ‹ç»™æ¯ä¸ªçº¿ç¨‹å­—èŠ‚çš„é”<code>gnne_dev_handle-&gt;is_lock</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">gnne_device_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-type">int</span> cmd, <span class="hljs-type">void</span> *args)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gnne_dev_handle</span> *<span class="hljs-title">handle</span>;</span><br>    <span class="hljs-type">int</span> ret = <span class="hljs-number">-1</span>;<br>    handle = (<span class="hljs-keyword">struct</span> gnne_dev_handle *)file-&gt;data;<br>    <span class="hljs-keyword">if</span> ((g_kpu_lock == HARDLOCK_MAX))&#123;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (cmd == GNNE_CMD_LOCK)&#123;<br>        <span class="hljs-keyword">if</span> (handle-&gt;is_lock == RT_TRUE)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">while</span>(kd_hardlock_lock(g_kpu_lock));<br>        handle-&gt;is_lock = RT_TRUE;<br>        ret = <span class="hljs-number">0</span>;<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == GNNE_CMD_UNLOCK)&#123;<br>        <span class="hljs-keyword">if</span> (handle-&gt;is_lock == RT_FALSE)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        kd_hardlock_unlock(g_kpu_lock);<br>        handle-&gt;is_lock = RT_FALSE;<br>        ret = <span class="hljs-number">0</span>;<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == GNNE_CMD_TRYLOCK)&#123;<br>        <span class="hljs-keyword">if</span> (handle-&gt;is_lock == RT_TRUE)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!kd_hardlock_lock(g_kpu_lock))&#123;<br>            handle-&gt;is_lock = RT_TRUE;<br>            ret = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœå­¦è¿‡æ“ä½œç³»ç»Ÿå…³äºç«äº‰ä¸å†’é™©è¿™ä¸€éƒ¨åˆ†ï¼Œåº”è¯¥çŸ¥é“ï¼Œä¸Šé”çš„è¯­å¥å¿…é¡»æ˜¯åŸå­æ€§çš„ï¼Œ<code>kd_hardlock_lock(g_kpu_lock)</code>çš„å®ç°å¦‚ä¸‹(<code>hardlock/drv_hardlock.c</code>)ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">kd_hardlock_lock</span><span class="hljs-params">(hardlock_type num)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(num &lt; <span class="hljs-number">0</span> || num &gt;= HARDLOCK_MAX)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">if</span>(!readl(hardlock.hw_base + num * <span class="hljs-number">0x4</span>))&#123;<br>        LOG_D(<span class="hljs-string">&quot;hardlock-%d locked\n&quot;</span>, num);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    LOG_D(<span class="hljs-string">&quot;hardlock-%d is busy\n&quot;</span>, num);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒæ˜¯é€šè¿‡<code>readl(hardlock.hw_base + num * 0x4)</code>è¿™ä¸ªåŸå­æ€§çš„æ“ä½œå®ç°ä¸Šé”ï¼Œ<code>g_kpu_lock</code>åœ¨<code>hardlock/drv_hardlock.h</code>è¢«å®šä¹‰ä¸º2ï¼Œ<code>hardlock.hw_base</code>æŒ‡å‘MailboxåŸºåœ°å€çš„<code>0x00A0</code>ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå¯„å­˜å™¨ï¼š<img src="/2025/12/25/K230-GNNE%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/image-20251226213106191.png" alt="image-20251226213106191"></p><p>é€šè¿‡<code>num*0x04</code>è¿›è¡Œ32ä½å¯„å­˜å™¨çš„å¯»å€ï¼Œå¦‚æœè¯»åˆ°æ˜¯0ï¼Œåˆ™ä¸ºä¸Šé”ã€‚ç›¸æ¯”äº<code>kd_hardlock_lock(hardlock_type num)</code>ï¼Œ<code>kd_hardlock_unlock(hardlock_type num)</code>å¤šäº†ä¸€å¥å†™0è§£é”çš„æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">kd_hardlock_unlock</span><span class="hljs-params">(hardlock_type num)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(num &lt; <span class="hljs-number">0</span> || num &gt;= HARDLOCK_MAX)<br>        <span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-keyword">if</span>(readl(hardlock.hw_base + num * <span class="hljs-number">0x4</span>))<br>    &#123;<br>        writel(<span class="hljs-number">0x0</span>, hardlock.hw_base + num * <span class="hljs-number">0x4</span>);<br>    &#125;<br>    LOG_D(<span class="hljs-string">&quot;hardlock-%d unlock\n&quot;</span>, num);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>gnne_device_poll</code>å®ç°äº†GNNEçš„<code>poll</code>æ¥å£ï¼Œè°ƒç”¨<code>gnne_input_fops.poll</code>åï¼Œè°ƒç”¨<code>rt_event_recv</code>è¿›å…¥é˜»å¡ï¼Œé‡Šæ”¾CPUï¼Œç­‰å¾…GNNEç¡¬ä»¶å®Œæˆè®¡ç®—ï¼Œä¸­æ–­å”¤é†’è¿™ä¸ªä»»åŠ¡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">gnne_device_poll</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dfs_file *file, <span class="hljs-keyword">struct</span> rt_pollreq *req)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gnne_dev_handle</span> *<span class="hljs-title">handle</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br>    handle = (<span class="hljs-keyword">struct</span> gnne_dev_handle *)file-&gt;data;<br>    <span class="hljs-keyword">if</span> (!handle)<br>    &#123;<br>        gnne_err(<span class="hljs-string">&quot;gnne_dev_handle NULL!&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EINVAL;<br>    &#125;<br>    rt_event_recv(&amp;g_gnne_event, <span class="hljs-number">0x01</span>, RT_EVENT_FLAG_OR | RT_EVENT_FLAG_CLEAR, RT_WAITING_FOREVER, <span class="hljs-literal">NULL</span>);<br>    rt_poll_add(handle-&gt;wait, req);<br>    <span class="hljs-keyword">return</span> POLLIN;<br>&#125;<br></code></pre></td></tr></table></figure><p>å”¤é†’çš„äº‹ä»¶æ¥è‡ª<code>irq_callback</code>ï¼Œè®¾å¤‡å°±ç»ªçš„ä¸­æ–­å‘å‡ºåï¼Œä¸­æ–­å›è°ƒå‡½æ•°æ¸…ç©ºæ ‡å¿—ä½ï¼Œå”¤é†’ç­‰å¾…é˜Ÿåˆ—å¹¶å‘é€äº‹ä»¶ï¼Œå”¤é†’é˜»å¡ä¸­çš„<code>gnne_device_poll</code>ã€‚å…¶ä¸­ï¼Œ<code>__iowmb()</code>æ˜¯å†…å­˜å±éšœï¼Œç¡®ä¿åœ¨æ¸…é™¤ä¸­æ–­æ ‡å¿—ä¹‹å‰ï¼Œæ‰€æœ‰ä¹‹å‰çš„å†…å­˜æ“ä½œéƒ½å·²å®Œæˆï¼Œé˜²æ­¢ç¼–è¯‘å™¨æˆ– CPU é‡æ’åºå¯¼è‡´ä¸­æ–­æ ‡å¿—è¿‡æ—©æ¸…é™¤ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">irq_callback</span><span class="hljs-params">(<span class="hljs-type">int</span> irq, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    <span class="hljs-type">rt_wqueue_t</span> *wait = (<span class="hljs-type">rt_wqueue_t</span> *)data;<br>    <span class="hljs-keyword">volatile</span> <span class="hljs-type">void</span> *write_addr = (<span class="hljs-type">void</span> *)((<span class="hljs-type">char</span> *)gnne_base_addr + <span class="hljs-number">0x128</span>);<br>    <span class="hljs-keyword">if</span> (gnne_base_addr == RT_NULL)<br>    &#123;<br>        gnne_err(<span class="hljs-string">&quot;gnne interrupts while the hardware is not yet initialized\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">/*clear kpu intr*/</span><br>    __iowmb();<br>    *(<span class="hljs-type">rt_uint64_t</span> *)write_addr = <span class="hljs-number">0x400000004</span>;<br>    rt_wqueue_wakeup(wait, (<span class="hljs-type">void</span> *)POLLIN);<br>    rt_event_send(&amp;g_gnne_event, <span class="hljs-number">0x1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ•´ä½“è°ƒç”¨æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><pre><code class=" mermaid">sequenceDiagram    participant User as ç”¨æˆ·è¿›ç¨‹    participant Poll as gnne_device_poll()    participant Event as rt_event_recv()    participant HW as GNNE ç¡¬ä»¶    participant IRQ as irq_callback()        User-&gt;&gt;Poll: è°ƒç”¨ poll()    Poll-&gt;&gt;Event: rt_event_recv() é˜»å¡ç­‰å¾…    Note over Event: ç­‰å¾…äº‹ä»¶ g_gnne_event        HW-&gt;&gt;HW: å®Œæˆè®¡ç®—    HW-&gt;&gt;IRQ: è§¦å‘ä¸­æ–­        IRQ-&gt;&gt;IRQ: æ¸…é™¤ä¸­æ–­æ ‡å¿—&lt;br/&gt;*(0x128) = 0x400000004    IRQ-&gt;&gt;Event: rt_event_send(g_gnne_event)    Note over Event: äº‹ä»¶åˆ°è¾¾ï¼Œå”¤é†’        Event--&gt;&gt;Poll: è¿”å›    Poll-&gt;&gt;Poll: rt_poll_add() æ³¨å†Œç­‰å¾…é˜Ÿåˆ—    Poll--&gt;&gt;User: return POLLIN    Note over User: poll() è¿”å›ï¼Œæ•°æ®å¯è¯»</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå®ç°ä¸æ ‡å‡†çš„ poll æœºåˆ¶æœ‰æ‰€ä¸åŒï¼š</p><ul><li>æ ‡å‡† pollï¼šå…ˆæ³¨å†Œç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™è¿”å› 0ï¼Œæœ‰æ•°æ®æ—¶é€šè¿‡ç­‰å¾…é˜Ÿåˆ—å”¤é†’</li><li>è¿™ä¸ªå®ç°ï¼šå…ˆé€šè¿‡ <code>rt_event_recv</code> åŒæ­¥ç­‰å¾…ï¼Œç­‰å¾…å®Œæˆåæ‰æ³¨å†Œç­‰å¾…é˜Ÿåˆ—</li></ul><p>è¿™ç§è®¾è®¡å¯èƒ½æ˜¯å› ä¸ºï¼š</p><ol><li>å®é™…çš„åŒæ­¥æœºåˆ¶å®Œå…¨ä¾èµ–äº‹ä»¶æœºåˆ¶ï¼ˆ<code>rt_event_recv</code> &#x2F; <code>rt_event_send</code>ï¼‰</li><li><code>rt_poll_add</code> åªæ˜¯ä¸ºäº†æ»¡è¶³ poll æ¡†æ¶çš„æ¥å£è¦æ±‚</li><li>å…·ä½“çš„æ—¶åºè¦æ±‚ä¸ NNCASE çš„è°ƒç”¨æ–¹å¼æœ‰å…³</li></ol><p>è¿™ä½¿å¾— poll è°ƒç”¨æ€»æ˜¯é˜»å¡çš„ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªâ€åŒæ­¥ç­‰å¾…ç¡¬ä»¶å®Œæˆâ€çš„æ¥å£ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„éé˜»å¡è½®è¯¢ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>K230-rt-smart</category>
      
    </categories>
    
    
    <tags>
      
      <tag>K230</tag>
      
      <tag>rt-smart</tag>
      
      <tag>åµŒå…¥å¼</tag>
      
      <tag>bsp</tag>
      
      <tag>gnne</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>K230-SPIé©±åŠ¨ç§»æ¤</title>
    <link href="/2025/12/18/K230-SPI%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/"/>
    <url>/2025/12/18/K230-SPI%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/</url>
    
    <content type="html"><![CDATA[<h2 id="SPIåè®®ç®€è¿°"><a href="#SPIåè®®ç®€è¿°" class="headerlink" title="SPIåè®®ç®€è¿°"></a>SPIåè®®ç®€è¿°</h2><h3 id="æ ‡å‡†SPI"><a href="#æ ‡å‡†SPI" class="headerlink" title="æ ‡å‡†SPI"></a>æ ‡å‡†SPI</h3><p>SPIï¼ˆSerial Peripheral Interfaceï¼‰æ˜¯ä¸€ç§é«˜é€Ÿã€å…¨åŒå·¥çš„åŒæ­¥ä¸²è¡Œé€šä¿¡åè®®ï¼Œå¹¿æ³›åº”ç”¨äºå¾®æ§åˆ¶å™¨ä¸å¤–è®¾ï¼ˆå¦‚Flashã€ä¼ æ„Ÿå™¨ã€æ˜¾ç¤ºå±ï¼‰ä¹‹é—´çš„é€šä¿¡ã€‚</p><p>æ ‡å‡†SPIæ—¶åºå¦‚ä¸‹(CPOL &#x3D; 1ï¼ŒCPHA &#x3D; 0)ï¼š</p><p><img src="/2025/12/18/K230-SPI%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/image-20251228001533771.png" alt="æ ‡å‡†SPIæ—¶åºå›¾"></p><p>æ³¨ï¼šå›¾ä¸­æ²¡æœ‰æ ‡å‡ºå¦‚ä¸‹çš„å»ºç«‹&#x2F;ä¿æŒæ—¶é—´ï¼Œè¿™äº›è¯¦ç»†æ—¶åºè¦æ±‚å¯ä»¥å‚è€ƒèŠ¯ç‰‡æ‰‹å†Œã€‚</p><ul><li>$t_{CSS}$: CSå»ºç«‹æ—¶é—´ï¼ˆCSä¸‹é™æ²¿åˆ°ç¬¬ä¸€ä¸ªæ—¶é’Ÿä¸Šå‡æ²¿ï¼‰</li><li>$t_{CSH}$: CSä¿æŒæ—¶é—´ï¼ˆæœ€åæ—¶é’Ÿä¸‹é™æ²¿åˆ°CSä¸Šå‡æ²¿ï¼‰</li><li>$t_{SU}$: æ•°æ®å»ºç«‹æ—¶é—´ï¼ˆæ•°æ®ç¨³å®šåˆ°æ—¶é’Ÿé‡‡æ ·æ²¿ï¼‰</li><li>$t_{H}$: æ•°æ®ä¿æŒæ—¶é—´ï¼ˆæ—¶é’Ÿé‡‡æ ·æ²¿åæ•°æ®ä¿æŒç¨³å®šï¼‰</li></ul><p>SPIæœ‰4ç§å·¥ä½œæ¨¡å¼ï¼Œç”±ä¸¤ä¸ªå‚æ•°å†³å®šï¼š</p><ul><li><strong>CPOLï¼ˆæ—¶é’Ÿææ€§ï¼‰</strong>ï¼šç©ºé—²æ—¶æ—¶é’Ÿçº¿çš„ç”µå¹³ï¼ˆ0&#x3D;ä½ç”µå¹³ï¼Œ1&#x3D;é«˜ç”µå¹³ï¼‰</li><li><strong>CPHAï¼ˆæ—¶é’Ÿç›¸ä½ï¼‰</strong>ï¼šæ•°æ®é‡‡æ ·æ—¶åˆ»ï¼ˆ0&#x3D;ç¬¬ä¸€ä¸ªè¾¹æ²¿ï¼Œ1&#x3D;ç¬¬äºŒä¸ªè¾¹æ²¿ï¼‰</li></ul><table><thead><tr><th align="left">æ¨¡å¼</th><th align="left">CPOL</th><th align="left">CPHA</th><th align="left">ç©ºé—²æ—¶é’Ÿ</th><th align="left">é‡‡æ ·è¾¹æ²¿</th><th align="left">è¾“å‡ºè¾¹æ²¿</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">ä½ç”µå¹³</td><td align="left">ä¸Šå‡æ²¿</td><td align="left">ä¸‹é™æ²¿</td></tr><tr><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">ä½ç”µå¹³</td><td align="left">ä¸‹é™æ²¿</td><td align="left">ä¸Šå‡æ²¿</td></tr><tr><td align="left">2</td><td align="left">1</td><td align="left">0</td><td align="left">é«˜ç”µå¹³</td><td align="left">ä¸‹é™æ²¿</td><td align="left">ä¸Šå‡æ²¿</td></tr><tr><td align="left">3</td><td align="left">1</td><td align="left">1</td><td align="left">é«˜ç”µå¹³</td><td align="left">ä¸Šå‡æ²¿</td><td align="left">ä¸‹é™æ²¿</td></tr></tbody></table><p><strong>æ¨¡å¼0å’Œæ¨¡å¼3æœ€å¸¸ç”¨</strong>ï¼Œå¤§å¤šæ•°SPIè®¾å¤‡æ”¯æŒå…¶ä¸­ä¹‹ä¸€ã€‚ä¸»ä»è®¾å¤‡å¿…é¡»ä½¿ç”¨ç›¸åŒçš„æ¨¡å¼æ‰èƒ½æ­£å¸¸é€šä¿¡ã€‚</p><p>è¯¦ç»†æ—¶åºå¦‚ä¸‹(æ—¶é’Ÿå»ºç«‹æ—¶é—´ä¸å‡†)</p><p><img src="/2025/12/18/K230-SPI%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/image-20251228002119199.png" alt="SPIå·¥ä½œæ¨¡å¼"></p><p>æ ‡å‡†SPIè™½ç„¶ç®€å•å¯é ï¼Œä½†åœ¨ç°ä»£åº”ç”¨ä¸­é¢ä¸´æ˜æ˜¾çš„å¸¦å®½ç“¶é¢ˆã€‚ç”±äºé‡‡ç”¨å•çº¿ä¼ è¾“æ–¹å¼ï¼ŒMOSIå’ŒMISOå„å ä¸€æ ¹çº¿è¿›è¡ŒåŠåŒå·¥æ•°æ®ä¼ è¾“ï¼Œå³ä½¿æ—¶é’Ÿé¢‘ç‡è¾¾åˆ°50MHzï¼Œå•çº¿ä¼ è¾“é€Ÿç‡ä¹Ÿä»…æœ‰6.25MB&#x2F;sã€‚è¿™åœ¨å¤§å®¹é‡Flashåº”ç”¨ä¸­å°¤ä¸ºçªå‡ºï¼šä»128MB Flashè¯»å–1MBæ•°æ®éœ€è¦çº¦160msï¼Œç³»ç»Ÿå¯åŠ¨æ—¶åŠ è½½æ•°MBå›ºä»¶ä¼šäº§ç”Ÿæ˜æ˜¾å»¶è¿Ÿï¼Œè€Œå®æ—¶åº”ç”¨ï¼ˆå¦‚è§†é¢‘ã€å›¾åƒå¤„ç†ï¼‰æ›´æ˜¯æ— æ³•æ»¡è¶³å¸¦å®½éœ€æ±‚ã€‚</p><h3 id="å¢å¼ºå‹SPI"><a href="#å¢å¼ºå‹SPI" class="headerlink" title="å¢å¼ºå‹SPI"></a>å¢å¼ºå‹SPI</h3><p>ä¸€ä¸ªæœ€ç®€å•çš„åŠæ³•æ˜¯å¢åŠ æ•°æ®çº¿çº¿ï¼Œè®©ä¼ è¾“å¹¶è¡ŒåŒ–ï¼Œå› æ­¤è¯ç”Ÿäº†Dual SPI(åŒçº¿)ã€Quad SPI(å››çº¿)ä»¥åŠOctal SPI(8çº¿)ã€‚æ ‡å‡†SPIé‡‡ç”¨å…¨åŒå·¥è®¾è®¡ï¼ŒMOSIå’ŒMISOæ˜¯ç‹¬ç«‹çš„å•å‘çº¿è·¯ï¼Œå¯åŒæ—¶æ”¶å‘æ•°æ®ã€‚è€ŒDSPI&#x2F;QSPI&#x2F;OSPIé‡‡ç”¨åŠåŒå·¥è®¾è®¡ï¼Œæ•°æ®çº¿æ˜¯åŒå‘å¤ç”¨çš„ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½è¿›è¡Œè¯»æˆ–å†™æ“ä½œã€‚è¿™ç§è®¾è®¡ç‰ºç‰²äº†å…¨åŒå·¥èƒ½åŠ›ï¼Œä½†é€šè¿‡å¢åŠ å¹¶è¡Œæ•°æ®çº¿å¤§å¹…æå‡äº†å•å‘ä¼ è¾“å¸¦å®½ã€‚</p><p>ä¸‰ç§å¢å¼ºå‹SPIåè®®ä¼ è¾“å¯ä»¥åˆ†æˆä¸‰ä¸ªé˜¶æ®µï¼šå‘½ä»¤ã€åœ°å€ã€æ•°æ®ï¼Œä»¥QSPIä¸ºä¾‹ï¼Œå…¶ä¼ è¾“æ—¶åºä¸ºï¼š</p><p><img src="/2025/12/18/K230-SPI%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/image-20251228190734725.png" alt="QSPIå‘é€æ¨¡å¼"></p><p>å›¾ä¸­ï¼Œå‘½ä»¤ä¸º4bitï¼Œå•çº¿ä¼ è¾“ï¼›åœ°å€å’Œæ•°æ®éƒ½æ˜¯8bitï¼Œ4çº¿ä¼ è¾“ã€‚å®é™…ä¸Šï¼Œå‘½ä»¤çº¿å’Œåœ°å€çº¿éƒ½å¯ä»¥ç”¨1&#x2F;2&#x2F;4&#x2F;8çº¿ä¼ è¾“(ä¹Ÿå°±æ˜¯å‘ä¸‹å…¼å®¹)ï¼Œæˆ–è€…çœç•¥ï¼Œè¿›è¡Œæ•°æ®é˜¶æ®µçš„ä¼ è¾“ã€‚</p><h2 id="ç¡¬ä»¶å¹³å°"><a href="#ç¡¬ä»¶å¹³å°" class="headerlink" title="ç¡¬ä»¶å¹³å°"></a>ç¡¬ä»¶å¹³å°</h2><p>ä»K230èŠ¯ç‰‡æ¶æ„å¯ä»¥çœ‹å‡ºï¼ŒK230æœ‰ä¸€ä¸ªOctal SPIæ§åˆ¶å™¨(OPI)å’Œä¸¤ä¸ªQuad SPIæ§åˆ¶å™¨(QPI)ã€‚</p><p><img src="/2025/12/18/K230-SPI%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/image-20251226114205250.png" alt="K230èŠ¯ç‰‡æ¶æ„"></p><p>å¯¹äºOPIï¼Œå…¶æ”¯æŒ1&#x2F;2&#x2F;4&#x2F;8çº¿ä¼ è¾“æ¨¡å¼ï¼Œæœ€å¤§æ—¶é’Ÿé¢‘ç‡ä¸º200MHzã€‚è€ŒQPIæ§åˆ¶å™¨æ”¯æŒ1&#x2F;2&#x2F;4çº¿ä¼ è¾“æ¨¡å¼ï¼Œæœ€å¤§é¢‘ç‡ä¸º100MHzã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒK230 çš„SPIæ§åˆ¶å™¨å†…éƒ¨é›†æˆäº†ä¸€å¥—è‡ªå·±çš„DMAï¼ˆæ‰‹å†Œé‡Œå«Internal DMAï¼‰ï¼Œç”¨æ¥ç›´æ¥åœ¨ SPI ä¸å†…å­˜ä¹‹é—´æ¬è¿æ•°æ®ã€‚å®ƒå’Œç³»ç»Ÿå¤–è®¾DMAæ§åˆ¶å™¨PDMAæ˜¯ä¸¤å¥—ç‹¬ç«‹çš„ç¡¬ä»¶ï¼Œäº’ä¸å¤ç”¨é€šé“ï¼Œæ‰€ä»¥SPIçš„DMAä¼ è¾“ä¸éœ€è¦èµ°ç»Ÿä¸€çš„PDMAæ¡†æ¶ï¼Œå¯¹PDMAé©±åŠ¨ä¹Ÿæ²¡æœ‰ä¾èµ–ã€‚</p><h2 id="é©±åŠ¨æ¶æ„è®¾è®¡"><a href="#é©±åŠ¨æ¶æ„è®¾è®¡" class="headerlink" title="é©±åŠ¨æ¶æ„è®¾è®¡"></a>é©±åŠ¨æ¶æ„è®¾è®¡</h2><h3 id="é…ç½®éƒ¨åˆ†"><a href="#é…ç½®éƒ¨åˆ†" class="headerlink" title="é…ç½®éƒ¨åˆ†"></a>é…ç½®éƒ¨åˆ†</h3><p>å¯¹äºRT-smartè€Œè¨€ï¼Œå…¶å†…æ ¸ä¸­æœ‰ä¸¤ä¸ªå’ŒSPIç›¸å…³çš„ç»„ä»¶ï¼šSPIå’ŒQSPIï¼ŒSPIçš„åŸºç¡€é…ç½®ç»“æ„ä½“<code>rt_spi_configuration</code>å®šä¹‰äº†æ ‡å‡†SPIçš„æ ¸å¿ƒå‚æ•°ï¼Œè€ŒQSPIé…ç½®ç»“æ„ä½“<code>rt_qspi_configuration</code>åœ¨æ ‡å‡†SPIåŸºç¡€ä¸Šæ‰©å±•äº†å¤šçº¿ä¼ è¾“èƒ½åŠ›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief SPI configuration structure</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_spi_configuration</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">rt_uint8_t</span> mode;<br>    <span class="hljs-type">rt_uint8_t</span> data_width;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RT_USING_DM</span><br>    <span class="hljs-type">rt_uint8_t</span> data_width_tx;<br>    <span class="hljs-type">rt_uint8_t</span> data_width_rx;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-type">rt_uint16_t</span> reserved;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-type">rt_uint32_t</span> max_hz;<br>&#125;;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief QSPI configuration structure</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_configuration</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_spi_configuration</span> <span class="hljs-title">parent</span>;</span><br>    <span class="hljs-comment">/* The size of medium */</span><br>    <span class="hljs-type">rt_uint32_t</span> medium_size;<br>    <span class="hljs-comment">/* double data rate mode */</span><br>    <span class="hljs-type">rt_uint8_t</span> ddr_mode;<br>    <span class="hljs-comment">/* the data lines max width which QSPI bus supported, such as 1, 2, 4 */</span><br>    <span class="hljs-type">rt_uint8_t</span> qspi_dl_width ;<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™ç§ç»§æ‰¿è®¾è®¡ä½¿å¾—QSPIé…ç½®å‘ä¸‹å…¼å®¹æ ‡å‡†SPIï¼ŒåŒæ—¶<code>qspi_dl_width</code>æ”¯æŒ8çº¿å‚æ•°ï¼Œå› æ­¤K230çš„æ‰€æœ‰SPIæ§åˆ¶å™¨ï¼ˆåŒ…æ‹¬OPIå’ŒQPIï¼‰éƒ½å¯ä»¥æ³¨å†Œä¸ºQSPIæ€»çº¿ã€‚</p><p>åœ¨RT-smartä¸­ï¼ŒQSPIå’ŒSPIè®¾å¤‡å…±ç”¨åŒä¸€å¥—æ“ä½œæ¥å£<code>rt_spi_ops</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief SPI operators</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_spi_ops</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">rt_err_t</span> (*configure)(<span class="hljs-keyword">struct</span> rt_spi_device *device, <span class="hljs-keyword">struct</span> rt_spi_configuration *configuration);<br>    <span class="hljs-type">rt_ssize_t</span> (*xfer)(<span class="hljs-keyword">struct</span> rt_spi_device *device, <span class="hljs-keyword">struct</span> rt_spi_message *message);<br>&#125;;<br></code></pre></td></tr></table></figure><p>é©±åŠ¨å¼€å‘çš„æ ¸å¿ƒå·¥ä½œå°±æ˜¯å®ç°è¿™ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆï¼š</p><ul><li><code>configure</code>ï¼šæ ¹æ®é…ç½®å‚æ•°åˆå§‹åŒ–ç¡¬ä»¶å¯„å­˜å™¨</li><li><code>xfer</code>ï¼šæ‰§è¡Œå®é™…çš„æ•°æ®ä¼ è¾“æ“ä½œ</li></ul><p>ç”±äºQSPIå’Œæ ‡å‡†SPIå…¼å®¹åŒä¸€å¥—æ¥å£ï¼Œ<code>rt_spi_ops</code>å†…éƒ¨ä¸¤ä¸ªè™šå‡½æ•°å‚æ•°ç”¨çš„æ˜¯<code>rt_spi_device</code>ï¼Œ<code>rt_spi_configuration</code>å’Œ<code>rt_spi_message</code>ã€‚å› æ­¤ï¼Œé©±åŠ¨å±‚éœ€è¦åˆ©ç”¨<code>rt_qspi_device-&gt;parent</code>å’Œ<code>rt_spi_device</code>é¦–åœ°å€ç›¸åŒçš„ç‰¹æ€§è¿›è¡Œå¼ºåˆ¶è½¬æ¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">rt_err_t</span> <span class="hljs-title function_">drv_spi_configure</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rt_spi_device *device, <span class="hljs-keyword">struct</span> rt_spi_configuration *configuration)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_device</span> *<span class="hljs-title">qspi_device</span> =</span> (<span class="hljs-keyword">struct</span> rt_qspi_device *)device;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_configuration</span> *<span class="hljs-title">qspi_cfg</span> =</span> &amp;qspi_device-&gt;config;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><span class="hljs-type">rt_ssize_t</span> <span class="hljs-title function_">drv_spi_xfer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rt_spi_device *device, <span class="hljs-keyword">struct</span> rt_spi_message *message)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_device</span> *<span class="hljs-title">qspi_device</span> =</span> (<span class="hljs-keyword">struct</span> rt_qspi_device *)device;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_message</span> *<span class="hljs-title">qspi_msg</span> =</span> (<span class="hljs-keyword">struct</span> rt_qspi_message *)message;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹çœ‹åº”ç”¨å±‚è°ƒç”¨QSPIæ€»çº¿çš„æµç¨‹ï¼Œéœ€è¦åšå“ªäº›é…ç½®ï¼Œä½¿ç”¨äº†å“ªäº›å‡½æ•°ï¼Œä»¥åŠç”¨æˆ·çš„å‚æ•°æ˜¯å¦‚ä½•ä»åº”ç”¨å±‚ä¼ é€’åˆ°é©±åŠ¨å±‚çš„opså§ã€‚è¯¦ç»†ä»£ç å‚è€ƒï¼š<a href="https://github.com/RT-Thread/rt-thread/blob/master/bsp/k230/drivers/utest/test_spi.c">K230 SPI utest</a></p><p>æŠ›å¼€GPIOçš„åŠŸèƒ½é…ç½®ä»¥åŠè¾“å…¥è¾“å‡ºæ¨¡å¼é€‰æ‹©ï¼Œé¦–å…ˆéœ€è¦æ‰¾åˆ°å·²æ³¨å†Œçš„SPIæ€»çº¿ï¼Œç„¶åå°†è®¾å¤‡æŒ‚è½½åˆ°æ€»çº¿ä¸Šã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Find QSPI Bus */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_spi_bus</span> *<span class="hljs-title">spi_bus</span> =</span> (<span class="hljs-keyword">struct</span> rt_spi_bus *)rt_device_find(SPI0_BUS_NAME);<br>qspi_dev = (<span class="hljs-keyword">struct</span> rt_qspi_device *)rt_malloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> rt_qspi_device));<br><span class="hljs-comment">/* Attach SPI Device */</span><br>ret = rt_spi_bus_attach_device(&amp;(qspi_dev-&gt;parent), SPI0_DEV_NAME0, SPI0_BUS_NAME, RT_NULL);<br></code></pre></td></tr></table></figure><p>ç”±äºRT-smartä¸æ”¯æŒç›´æ¥è®¿é—®SPIæ€»çº¿ï¼Œå› æ­¤åº”ç”¨å±‚å¿…é¡»ç»‘å®šè®¾å¤‡ï¼Œä»¥è®¾å¤‡çš„å½¢å¼è¿›è¡Œæ€»çº¿æ“ä½œã€‚è¿™ç§è®¾è®¡å…è®¸ä¸€æ¡æ€»çº¿ä¸ŠæŒ‚è½½å¤šä¸ªè®¾å¤‡ï¼Œæ¯ä¸ªè®¾å¤‡å¯ä»¥æœ‰ç‹¬ç«‹çš„é…ç½®å‚æ•°ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯åˆ›å»ºé…ç½®ç»“æ„ä½“å¹¶è®¾ç½®å‚æ•°ï¼Œç„¶åè°ƒç”¨é…ç½®å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* SPI Device Config*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_configuration</span> <span class="hljs-title">qspi_cfg</span>;</span><br>qspi_cfg.parent.mode = RT_SPI_MODE_0 | RT_SPI_MSB;<br>qspi_cfg.parent.data_width = <span class="hljs-number">8</span>;<br>qspi_cfg.parent.max_hz = <span class="hljs-number">1000000</span>;<br>qspi_cfg.parent.reserved = <span class="hljs-number">0</span>;<br>qspi_cfg.qspi_dl_width = <span class="hljs-number">1</span>;<br>qspi_cfg.medium_size = <span class="hljs-number">0</span>;<br>qspi_cfg.ddr_mode = <span class="hljs-number">0</span>;<br><br>ret = rt_qspi_configure(qspi_dev, &amp;qspi_cfg);<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒæ˜¯<code>rt_qspi_configure</code>è¿™ä¸ªå‡½æ•°ï¼Œå®ƒçš„å®ç°åœ¨<a href="https://github.com/RT-Thread/rt-thread/blob/master/components/drivers/spi/dev_qspi_core.c">dev_qspi_core.c</a>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">rt_err_t</span> <span class="hljs-title function_">rt_qspi_configure</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rt_qspi_device *device, <span class="hljs-keyword">struct</span> rt_qspi_configuration *cfg)</span><br>&#123;<br>    RT_ASSERT(device != RT_NULL);<br>    RT_ASSERT(cfg != RT_NULL);<br><br>    <span class="hljs-comment">/* reset the CS pin */</span><br>    ...............................<br>    <span class="hljs-comment">/* If the configurations are the same, we don&#x27;t need to set again. */</span><br>    <span class="hljs-keyword">if</span> (device-&gt;config.medium_size       == cfg-&gt;medium_size &amp;&amp;<br>        device-&gt;config.ddr_mode          == cfg-&gt;ddr_mode &amp;&amp;<br>        device-&gt;config.qspi_dl_width     == cfg-&gt;qspi_dl_width &amp;&amp;<br>        device-&gt;config.parent.data_width == cfg-&gt;parent.data_width &amp;&amp;<br>        device-&gt;config.parent.mode       == (cfg-&gt;parent.mode &amp; RT_SPI_MODE_MASK) &amp;&amp;<br>        device-&gt;config.parent.max_hz     == cfg-&gt;parent.max_hz)<br>    &#123;<br>        <span class="hljs-keyword">return</span> RT_EOK;<br>    &#125;<br>    <span class="hljs-comment">/* copy configuration items */</span><br>    device-&gt;config.parent.mode = cfg-&gt;parent.mode;<br>    device-&gt;config.parent.max_hz = cfg-&gt;parent.max_hz;<br>    device-&gt;config.parent.data_width = cfg-&gt;parent.data_width;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RT_USING_DM</span><br>    device-&gt;config.parent.data_width_tx = cfg-&gt;parent.data_width_tx;<br>    device-&gt;config.parent.data_width_rx = cfg-&gt;parent.data_width_rx;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    device-&gt;config.parent.reserved = cfg-&gt;parent.reserved;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    device-&gt;config.medium_size = cfg-&gt;medium_size;<br>    device-&gt;config.ddr_mode = cfg-&gt;ddr_mode;<br>    device-&gt;config.qspi_dl_width = cfg-&gt;qspi_dl_width;<br><br>    <span class="hljs-keyword">return</span> rt_spi_bus_configure(&amp;device-&gt;parent);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æˆ‘çœç•¥äº†è½¯ä»¶CSè¿™ä¸€éƒ¨åˆ†ï¼Œ<code>rt_qspi_configure</code>ä¸­ï¼Œå¯¹æ¯”äº†<code>rt_qspi_device-&gt;config</code>å’Œ<code>rt_qspi_configuration</code>çš„æ–°æ—§ç‰ˆé…ç½®ï¼Œé¿å…é‡å¤é…ç½®ç¡¬ä»¶ï¼Œå°†ç”¨æˆ·é…ç½®ä¿å­˜åˆ°<code>device-&gt;config</code>ä¸­ï¼Œè°ƒç”¨åº•å±‚æ€»çº¿é…ç½®å‡½æ•°</p><p><code>rt_qspi_device</code>çš„å®šä¹‰å±•ç¤ºäº†è®¾å¤‡ã€é…ç½®å’Œæ€»çº¿çš„å…³ç³»ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief QSPI operators</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_device</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_spi_device</span> <span class="hljs-title">parent</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_configuration</span> <span class="hljs-title">config</span>;</span><br>    <span class="hljs-type">void</span> (*enter_qspi_mode)(<span class="hljs-keyword">struct</span> rt_qspi_device *device);<br>    <span class="hljs-type">void</span> (*exit_qspi_mode)(<span class="hljs-keyword">struct</span> rt_qspi_device *device);<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>rt_qspi_device</code>çš„çˆ¶ç±»æ˜¯<code>rt_spi_device</code>ï¼Œè€Œå®ƒè‡ªå·±ä¹Ÿæœ‰ä¸€ä¸ªqspié…ç½®ç»“æ„ä½“<code>rt_qspi_configuration</code>ï¼Œå†çœ‹<code>rt_spi_bus_configure</code>è¿™ä¸ªå‡½æ•°ï¼Œå®ƒçš„å®ç°åœ¨ï¼š<a href="https://github.com/RT-Thread/rt-thread/blob/master/components/drivers/spi/dev_spi_core.c">dev_spi_core.c</a>ï¼Œè¿™æ˜¯é…ç½®æµç¨‹çš„æœ€åä¸€ç¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">rt_err_t</span> <span class="hljs-title function_">rt_spi_bus_configure</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rt_spi_device *device)</span><br>&#123;<br>    <span class="hljs-type">rt_err_t</span> result = -RT_ERROR;<br>    <span class="hljs-keyword">if</span> (device-&gt;bus != RT_NULL)&#123;<br>        result = spi_lock(device-&gt;bus);<br>        <span class="hljs-keyword">if</span> (result == RT_EOK)&#123;<br>            <span class="hljs-keyword">if</span> (device-&gt;bus-&gt;owner == device)&#123;<br>                result = device-&gt;bus-&gt;ops-&gt;configure(device, &amp;device-&gt;config);<br>                <span class="hljs-keyword">if</span> (result != RT_EOK)&#123;<br>                    LOG_E(<span class="hljs-string">&quot;SPI device %s configuration failed&quot;</span>, device-&gt;parent.parent.name);<br>                &#125;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                result = -RT_EBUSY;<br>            &#125;<br>            spi_unlock(device-&gt;bus);<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        result = RT_EOK;<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç¡®è®¤è·å–é”åï¼Œ<code>rt_spi_bus_configure</code>ä¼šæŠŠé…ç½®éƒ¨åˆ†ä¼ é€’ç»™opsç»“æ„ä½“ï¼š<code>device-&gt;bus-&gt;ops-&gt;configure(device, &amp;device-&gt;config)</code>ã€‚</p><p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªéœ€è¦æ³¨æ„çš„é—®é¢˜ï¼š<code>rt_spi_bus_configure</code>æ¥æ”¶çš„<code>device</code>å‚æ•°ç±»å‹æ˜¯<code>rt_spi_device</code>ï¼ˆå³<code>rt_qspi_device-&gt;parent</code>ï¼‰ï¼Œå› æ­¤ä¼ é€’ç»™é©±åŠ¨å±‚çš„é…ç½®å‚æ•°<code>&amp;device-&gt;config</code>å®é™…æŒ‡å‘<code>rt_qspi_device-&gt;parent.config</code>ï¼Œè€Œä¸æ˜¯<code>rt_qspi_device-&gt;config.parent</code>ã€‚</p><p>è¿™æ„å‘³ç€é©±åŠ¨å±‚çš„ <code>configure</code> å‡½æ•°æ”¶åˆ°çš„ç¬¬äºŒä¸ªå‚æ•° <code>configuration</code> å…¶å®å¹¶ä¸æ˜¯åº”ç”¨å±‚ç¨‹åºåœ¨ <code>rt_qspi_configure</code> é‡Œè®¾ç½®çš„é‚£ä»½é…ç½®ã€‚å› æ­¤é©±åŠ¨å®ç°æ—¶æ²¡æ³•ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼Œè€Œæ˜¯è¦å…ˆæŠŠ <code>device</code> å¼ºè½¬å› <code>rt_qspi_device</code>ï¼Œå†ä» <code>qspi_device-&gt;config</code>ï¼ˆé‡Œå–çœŸæ­£çš„é…ç½®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">rt_err_t</span> <span class="hljs-title function_">drv_spi_configure</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rt_spi_device *device, <span class="hljs-keyword">struct</span> rt_spi_configuration *configuration)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_device</span> *<span class="hljs-title">qspi_device</span> =</span> (<span class="hljs-keyword">struct</span> rt_qspi_device *)device;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_configuration</span> *<span class="hljs-title">qspi_cfg</span> =</span> &amp;qspi_device-&gt;config;  <span class="hljs-comment">// æ­£ç¡®çš„é…ç½®</span><br><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¼ è¾“éƒ¨åˆ†"><a href="#ä¼ è¾“éƒ¨åˆ†" class="headerlink" title="ä¼ è¾“éƒ¨åˆ†"></a>ä¼ è¾“éƒ¨åˆ†</h3><p>QSPIæ¶ˆæ¯ç»“æ„ä½“<code>rt_qspi_message</code>å®Œæ•´æè¿°äº†ä¼ è¾“ä¿¡æ¯çš„æ‰€æœ‰å‚æ•°ã€‚å…¶å®šä¹‰ä½äºï¼š<a href="https://github.com/RT-Thread/rt-thread/blob/master/components/drivers/include/drivers/dev_spi.h">dev_spi.h</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_message</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_spi_message</span> <span class="hljs-title">parent</span>;</span><br>    <span class="hljs-comment">/* instruction stage */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">    &#123;</span><br>        <span class="hljs-type">rt_uint8_t</span> content;<br>        <span class="hljs-type">rt_uint8_t</span> qspi_lines;<br>    &#125; instruction;<br>    <span class="hljs-comment">/* address and alternate_bytes stage */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">    &#123;</span><br>        <span class="hljs-type">rt_uint32_t</span> content;<br>        <span class="hljs-type">rt_uint8_t</span> size;<br>        <span class="hljs-type">rt_uint8_t</span> qspi_lines;<br>    &#125; address, alternate_bytes;<br>    <span class="hljs-comment">/* dummy_cycles stage */</span><br>    <span class="hljs-type">rt_uint32_t</span> dummy_cycles;<br>    <span class="hljs-comment">/* number of lines in qspi data stage, the other configuration items are in parent */</span><br>    <span class="hljs-type">rt_uint8_t</span> qspi_data_lines;<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ä½“ç»§æ‰¿è‡ªæ ‡å‡†SPIæ¶ˆæ¯<code>rt_spi_message</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_spi_message</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">void</span> *send_buf;<br>    <span class="hljs-type">void</span> *recv_buf;<br>    <span class="hljs-type">rt_size_t</span> length;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_spi_message</span> *<span class="hljs-title">next</span>;</span><br><br>    <span class="hljs-type">unsigned</span> cs_take    : <span class="hljs-number">1</span>;<br>    <span class="hljs-type">unsigned</span> cs_release : <span class="hljs-number">1</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>rt_qspi_message</code>å¯¹åº”å¢å¼ºå‹SPIçš„ä¸‰ä¸ªä¼ è¾“é˜¶æ®µï¼š</p><ul><li><strong>instruction</strong>ï¼šå‘½ä»¤é˜¶æ®µï¼ŒåŒ…å«å‘½ä»¤å†…å®¹å’Œçº¿æ•°é…ç½®</li><li><strong>address</strong>ï¼šåœ°å€é˜¶æ®µï¼ŒåŒ…å«åœ°å€å†…å®¹ã€é•¿åº¦å’Œçº¿æ•°é…ç½®</li><li><strong>parent</strong>ï¼šæ•°æ®é˜¶æ®µï¼Œç»§æ‰¿è‡ª<code>rt_spi_message</code>ï¼ŒåŒ…å«å‘é€&#x2F;æ¥æ”¶ç¼“å†²åŒºå’Œé•¿åº¦</li></ul><p>æ¯ä¸ªé˜¶æ®µéƒ½å¯ä»¥ç‹¬ç«‹é…ç½®çº¿æ•°ï¼ˆ1&#x2F;2&#x2F;4&#x2F;8ï¼‰ï¼Œå®ç°çµæ´»çš„ä¼ è¾“ç»„åˆã€‚ä¾‹å¦‚ä¸‹é¢çš„é…ç½®å®é™…æ˜¯æŠŠQSPIå½“æ ‡å‡†SPIä½¿ç”¨ï¼šå‘½ä»¤å’Œåœ°å€é˜¶æ®µéƒ½çœç•¥ï¼ˆsize&#x3D;0ï¼‰ï¼Œåªè¿›è¡Œæ•°æ®é˜¶æ®µçš„å•çº¿ä¼ è¾“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Create SPI Message */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_message</span> <span class="hljs-title">msg</span>;</span><br>rt_memset(&amp;msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(msg));<br><span class="hljs-comment">/*Using Standard SPI*/</span><br>msg.instruction.content = <span class="hljs-number">0</span>;<br>msg.instruction.qspi_lines = <span class="hljs-number">1</span>;<br>msg.address.content = <span class="hljs-number">0</span>;<br>msg.address.size = <span class="hljs-number">0</span>;<br>msg.address.qspi_lines = <span class="hljs-number">1</span>;<br>msg.qspi_data_lines = <span class="hljs-number">1</span>;<br>msg.dummy_cycles = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">/* SPI Message Config */</span><br>msg.parent.send_buf = tx_data;<br>msg.parent.recv_buf = rx_data;<br>msg.parent.length = TEST_DATA_LENGTH;<br>msg.parent.cs_take = <span class="hljs-number">1</span>;<br>msg.parent.cs_release = <span class="hljs-number">1</span>;<br>msg.parent.next = RT_NULL;<br><br><span class="hljs-comment">/* Transfer Data */</span><br>ret = rt_qspi_transfer_message(qspi_dev, &amp;msg);<br></code></pre></td></tr></table></figure><p><code>rt_qspi_transfer_message</code>å‡½æ•°æ˜¯ä¼ è¾“æµç¨‹çš„å…¥å£ï¼Œå…¶å®ç°å±•ç¤ºäº†å†…æ ¸å¦‚ä½•å¤„ç†æ€»çº¿å…±äº«å’Œè®¾å¤‡åˆ‡æ¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">rt_ssize_t</span> <span class="hljs-title function_">rt_qspi_transfer_message</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rt_qspi_device  *device, <span class="hljs-keyword">struct</span> rt_qspi_message *message)</span><br>&#123;<br>    <span class="hljs-type">rt_ssize_t</span> result;<br>    RT_ASSERT(device != RT_NULL);<br>    RT_ASSERT(message != RT_NULL);<br>    result = rt_mutex_take(&amp;(device-&gt;parent.bus-&gt;lock), RT_WAITING_FOREVER);<br>    <span class="hljs-keyword">if</span> (result != RT_EOK)&#123;<br>        rt_set_errno(-RT_EBUSY);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    rt_set_errno(RT_EOK);<br><span class="hljs-comment">/* configure SPI bus */</span><br>    <span class="hljs-keyword">if</span> (device-&gt;parent.bus-&gt;owner != &amp;device-&gt;parent)&#123;<br><span class="hljs-comment">/* not the same owner as current, re-configure SPI bus */</span><br>        result = device-&gt;parent.bus-&gt;ops-&gt;configure(&amp;device-&gt;parent, &amp;device-&gt;parent.config);<br>        <span class="hljs-keyword">if</span> (result == RT_EOK)&#123;<br>            device-&gt;parent.bus-&gt;owner = &amp;device-&gt;parent;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            rt_set_errno(-RT_EIO);<br>            <span class="hljs-keyword">goto</span> __exit;<br>        &#125;<br>    &#125;<br>    result = device-&gt;parent.bus-&gt;ops-&gt;xfer(&amp;device-&gt;parent, &amp;message-&gt;parent);<br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-number">0</span>)&#123;<br>        rt_set_errno(-RT_EIO);<br>    &#125;<br>__exit:<br>    rt_mutex_release(&amp;(device-&gt;parent.bus-&gt;lock));<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>SPIæ€»çº¿ç»å¸¸é‡åˆ°å¤šè®¾å¤‡å…±äº«çš„æƒ…å†µã€‚é™¤äº†äº’æ–¥é”ï¼ŒRT-smartè¿˜é€šè¿‡æ€»çº¿æ‰€æœ‰æƒæœºåˆ¶æ¥å¤„ç†ï¼šå¯¹æ¯”å½“å‰æ€»çº¿æ‹¥æœ‰è€…æ˜¯å¦æ˜¯å½“å‰è®¾å¤‡ï¼Œå¦‚æœä¸æ˜¯åˆ™é‡æ–°é…ç½®<code>device-&gt;parent.bus-&gt;ops-&gt;configure(&amp;device-&gt;parent, &amp;device-&gt;parent.config)</code>ã€‚è¿™æ ·ä¸åŒé…ç½®çš„è®¾å¤‡å¯ä»¥å…±äº«åŒä¸€æ¡æ€»çº¿ã€‚é…ç½®å®Œæˆåï¼Œè°ƒç”¨é©±åŠ¨å±‚opsä¼ è¾“æ•°æ®ï¼š<code>device-&gt;parent.bus-&gt;ops-&gt;xfer(&amp;device-&gt;parent, &amp;message-&gt;parent)</code></p><h2 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h2><p>ä¹‹å‰æåˆ°ï¼Œé©±åŠ¨å±‚é™¤äº†ä¸­æ–­æ³¨å†Œï¼Œè®¾å¤‡æ³¨å†Œç­‰ï¼Œå…¶æ ¸å¿ƒå°±æ˜¯å®ç°<code>rt_spi_ops</code>è¿™ä¸ªç»“æ„ä½“ä¸­çš„è™šå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æ€»çº¿çš„æ“ä½œæ–¹æ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_spi_ops</span> <span class="hljs-title">k230_qspi_ops</span> =</span><br>&#123;<br>    .configure = k230_spi_configure,<br>    .xfer = k230_spi_xfer,<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨é©±åŠ¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ç°åˆå§‹åŒ–<code>rt_hw_qspi_bus_init</code>ï¼Œé…ç½®<code>k230_spi_configure</code>ï¼Œä¼ è¾“<code>k230_spi_xfer</code>ä»¥åŠä¸­æ–­å›è°ƒå‡½æ•°<code>k230_spi_irq</code>ï¼Œé©±åŠ¨çš„è¯¦ç»†ä»£ç å‚è€ƒï¼š<a href="https://github.com/RT-Thread/rt-thread/tree/master/bsp/k230/drivers/interdrv/spi">K230 SPIé©±åŠ¨</a></p><h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>é©±åŠ¨çš„åˆå§‹åŒ–å‘ç”Ÿåœ¨å†…æ ¸å¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨ç”¨æˆ·æ€å¯ç”¨ä¹‹å‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">rt_hw_qspi_bus_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">rt_err_t</span> ret;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">sizeof</span>(k230_spi_devs) / <span class="hljs-keyword">sizeof</span>(k230_spi_devs[<span class="hljs-number">0</span>]); i++)<br>    &#123;<br>        k230_spi_devs[i].base = rt_ioremap((<span class="hljs-type">void</span> *)k230_spi_devs[i].pa_base, k230_spi_devs[i].size);<br>        ret = rt_qspi_bus_register(&amp;k230_spi_devs[i].dev, k230_spi_devs[i].name, &amp;k230_qspi_ops);<br>        <span class="hljs-keyword">if</span> (ret)<br>        &#123;<br>            LOG_E(<span class="hljs-string">&quot;%s register fail&quot;</span>, k230_spi_devs[i].name);<br>            <span class="hljs-keyword">return</span> ret;<br>        &#125;<br>        rt_event_init(&amp;k230_spi_devs[i].event, k230_spi_devs[i].event_name, RT_IPC_FLAG_PRIO);<br>        rt_hw_interrupt_install(k230_spi_devs[i].<span class="hljs-built_in">vector</span> + SSI_TXE, k230_spi_irq, &amp;k230_spi_devs[i], k230_spi_devs[i].name);<br>        rt_hw_interrupt_umask(k230_spi_devs[i].<span class="hljs-built_in">vector</span>  + SSI_TXE);<br>        rt_hw_interrupt_install(k230_spi_devs[i].<span class="hljs-built_in">vector</span>  + SSI_RXF, k230_spi_irq, &amp;k230_spi_devs[i], k230_spi_devs[i].name);<br>        rt_hw_interrupt_umask(k230_spi_devs[i].<span class="hljs-built_in">vector</span>  + SSI_RXF);<br>        rt_hw_interrupt_install(k230_spi_devs[i].<span class="hljs-built_in">vector</span>  + SSI_DONE, k230_spi_irq, &amp;k230_spi_devs[i], k230_spi_devs[i].name);<br>        rt_hw_interrupt_umask(k230_spi_devs[i].<span class="hljs-built_in">vector</span>  + SSI_DONE);<br>        rt_hw_interrupt_install(k230_spi_devs[i].<span class="hljs-built_in">vector</span>  + SSI_AXIE, k230_spi_irq, &amp;k230_spi_devs[i], k230_spi_devs[i].name);<br>        rt_hw_interrupt_umask(k230_spi_devs[i].<span class="hljs-built_in">vector</span>  + SSI_AXIE);<br>    &#125;<br>    <span class="hljs-keyword">return</span> RT_EOK;<br>&#125;<br>INIT_DEVICE_EXPORT(rt_hw_qspi_bus_init);<br></code></pre></td></tr></table></figure><p>é©±åŠ¨åˆå§‹åŒ–åœ¨å†…æ ¸å¯åŠ¨æ—¶å®Œæˆï¼Œé€šè¿‡<code>INIT_DEVICE_EXPORT</code>ï¼Œå®ç°ä¸»è¦å·¥ä½œåŒ…æ‹¬ï¼š</p><ul><li><p><strong>å¯„å­˜å™¨æ˜ å°„</strong>ï¼šé€šè¿‡<code>rt_ioremap</code>å°†ç‰©ç†åœ°å€æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œ<code>k230_spi_devs[i].base</code>è¢«å†…å­˜æ˜ å°„IOæŒ‡å‘SPIç›¸å…³çš„å¯„å­˜å™¨ï¼Œä¹Ÿå°±æ˜¯ä»<code>k230_spi_devs[i].pa_base</code>å¼€å§‹ï¼Œå‘é«˜ä½åç§»<code>k230_spi_devs[i].size</code>å­—èŠ‚ï¼Œå…·ä½“Memory Mapå‚æ•°å‚è€ƒ<a href="https://github.com/RT-Thread/rt-thread/blob/master/bsp/k230/board/board.h">board.h</a>ã€‚</p></li><li><p><strong>æ€»çº¿æ³¨å†Œ</strong>ï¼šè°ƒç”¨<code>rt_qspi_bus_register</code>æ³¨å†ŒQSPIæ€»çº¿ã€‚</p></li><li><p><strong>ä¸­æ–­æ³¨å†Œ</strong>ï¼šæ³¨å†Œå‘é€ç©º(SSI_TXE)ã€æ¥æ”¶æ»¡(SSI_RXF)ã€ä¼ è¾“å®Œæˆ(SSI_DONE)å’ŒAXIé”™è¯¯(SSI_AXIE)å››ä¸ªä¸­æ–­ã€‚</p></li></ul><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>é…ç½®å‡½æ•°<code>k230_spi_configure</code>é¦–å…ˆè¿›è¡Œå‚æ•°æ ¡éªŒï¼Œç¡®ä¿çº¿æ•°ä¸è¶…è¿‡ç¡¬ä»¶é™åˆ¶ï¼ˆOPIæœ€å¤§8çº¿ï¼ŒQPIæœ€å¤§4çº¿ï¼‰ï¼Œæ•°æ®å®½åº¦åœ¨4-32ä½èŒƒå›´å†…ï¼Œæ—¶é’Ÿé¢‘ç‡ä¸è¶…è¿‡ç¡¬ä»¶æœ€å¤§å€¼ã€‚</p><p>ç„¶åæ˜¯é…ç½®æ—¶é’Ÿï¼Œå…ˆè·å–SPIæ§åˆ¶å™¨çš„æ—¶é’Ÿé¢‘ç‡ï¼Œç„¶åè®¡ç®—åˆ†é¢‘ç³»æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (qspi_bus-&gt;idx == <span class="hljs-number">0</span>)&#123;<br>    qspi_clk = sysctl_clk_get_leaf_freq(SYSCTL_CLK_SSI0);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (qspi_bus-&gt;idx == <span class="hljs-number">1</span>)&#123;<br>    qspi_clk = sysctl_clk_get_leaf_freq(SYSCTL_CLK_SSI1);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (qspi_bus-&gt;idx == <span class="hljs-number">2</span>)&#123;<br>    qspi_clk = sysctl_clk_get_leaf_freq(SYSCTL_CLK_SSI2);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯å°†åº”ç”¨å±‚çš„é…ç½®å‚æ•°æ˜ å°„åˆ°ç¡¬ä»¶å¯„å­˜å™¨ã€‚å…¶ä¸­ï¼Œ<code>qspi_dl_width</code>å†³å®šäº†SPIä¼ è¾“æ¨¡å¼ï¼ˆæ ‡å‡†&#x2F;åŒçº¿&#x2F;å››çº¿&#x2F;å…«çº¿ï¼‰ï¼Œ<code>mode</code>åŒ…å«CPOLå’ŒCPHAé…ç½®ï¼Œ<code>data_width</code>å¯¹åº”æ•°æ®å¸§å¤§å°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (qspi_cfg-&gt;qspi_dl_width == <span class="hljs-number">1</span>)&#123;<br>spi_ff = SPI_FRF_STD_SPI;<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (qspi_cfg-&gt;qspi_dl_width == <span class="hljs-number">2</span>)&#123;<br>spi_ff = SPI_FRF_DUAL_SPI;<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (qspi_cfg-&gt;qspi_dl_width == <span class="hljs-number">4</span>)&#123;<br>    spi_ff = SPI_FRF_QUAD_SPI;<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (qspi_cfg-&gt;qspi_dl_width == <span class="hljs-number">8</span>) &#123;<br>    spi_ff = SPI_FRF_OCT_SPI;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">return</span> -RT_EINVAL;<br>&#125;<br>mode = qspi_cfg_parent-&gt;mode &amp; RT_SPI_MODE_3;<br>dfs = qspi_cfg_parent-&gt;data_width - <span class="hljs-number">1</span>;<br>qspi_reg-&gt;ssienr = <span class="hljs-number">0</span>;                                          <span class="hljs-comment">// ç¦ç”¨æ§åˆ¶å™¨</span><br>qspi_reg-&gt;ser = <span class="hljs-number">0</span>;                                             <span class="hljs-comment">// ç¦ç”¨ç‰‡é€‰</span><br>qspi_reg-&gt;baudr = qspi_clk / max_hz;                          <span class="hljs-comment">// æ—¶é’Ÿåˆ†é¢‘</span><br>qspi_reg-&gt;rx_sample_delay = qspi_bus-&gt;rdse &lt;&lt; <span class="hljs-number">16</span> | qspi_bus-&gt;rdsd;  <span class="hljs-comment">// é‡‡æ ·å»¶è¿Ÿ</span><br>qspi_reg-&gt;axiawlen = SSIC_AXI_BLW &lt;&lt; <span class="hljs-number">8</span>;                       <span class="hljs-comment">// AXIå†™çªå‘é•¿åº¦</span><br>qspi_reg-&gt;axiarlen = SSIC_AXI_BLW &lt;&lt; <span class="hljs-number">8</span>;                       <span class="hljs-comment">// AXIè¯»çªå‘é•¿åº¦</span><br>qspi_reg-&gt;ctrlr0 = (dfs) | (mode &lt;&lt; <span class="hljs-number">8</span>) | (spi_ff &lt;&lt; <span class="hljs-number">22</span>);     <span class="hljs-comment">// æ§åˆ¶å¯„å­˜å™¨</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ¶‰åŠçš„å¯„å­˜å™¨åŒ…æ‹¬ï¼š<code>ssienr</code>ï¼ˆä½¿èƒ½æ§åˆ¶ï¼‰ã€<code>ser</code>ï¼ˆç‰‡é€‰ï¼‰ã€<code>baudr</code>ï¼ˆæ³¢ç‰¹ç‡ï¼‰ã€<code>rx_sample_delay</code>ï¼ˆæ¥æ”¶é‡‡æ ·å»¶è¿Ÿï¼‰ã€<code>axiawlen</code>å’Œ<code>axiarlen</code>ï¼ˆAXIçªå‘é•¿åº¦ï¼‰ã€<code>ctrlr0</code>ï¼ˆä¸»æ§åˆ¶å¯„å­˜å™¨ï¼‰ã€‚è¯¦ç»†çš„å¯„å­˜å™¨å®šä¹‰å‚è€ƒ<a href="https://kendryte-download.canaan-creative.com/developer/k230/HDK/K230%E7%A1%AC%E4%BB%B6%E6%96%87%E6%A1%A3/K230_Technical_Reference_Manual_V0.3.1_20241118.pdf">K230æŠ€æœ¯å‚è€ƒæ‰‹å†Œ</a>ã€‚</p><h3 id="ä¼ è¾“"><a href="#ä¼ è¾“" class="headerlink" title="ä¼ è¾“"></a>ä¼ è¾“</h3><p>ä¼ è¾“å‡½æ•°<code>k230_spi_xfer</code>æ ¹æ®ä¼ è¾“æ¨¡å¼åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼šæ ‡å‡†å•çº¿SPIå’Œå¢å¼ºå‹å¤šçº¿SPIã€‚å‡½æ•°é¦–å…ˆé€šè¿‡åˆ¤æ–­<code>qspi_data_lines</code>æ¥å†³å®šä½¿ç”¨å“ªç§ä¼ è¾“æ–¹å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">rt_ssize_t</span> <span class="hljs-title function_">k230_spi_xfer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rt_spi_device *device, <span class="hljs-keyword">struct</span> rt_spi_message *message)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">k230_spi_dev</span> *<span class="hljs-title">qspi_bus</span> =</span> (<span class="hljs-keyword">struct</span> k230_spi_dev *)device-&gt;bus;<br>    <span class="hljs-type">k230_spi_reg_t</span> *qspi_reg = (<span class="hljs-type">k230_spi_reg_t</span> *)qspi_bus-&gt;base;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_device</span> *<span class="hljs-title">dev</span> =</span> (<span class="hljs-keyword">struct</span> rt_qspi_device *)device;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_configuration</span> *<span class="hljs-title">qspi_cfg</span> =</span> &amp;dev-&gt;config;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_spi_configuration</span> *<span class="hljs-title">qspi_cfg_parent</span> =</span> &amp;dev-&gt;config.parent;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_qspi_message</span> *<span class="hljs-title">msg</span> =</span> (<span class="hljs-keyword">struct</span> rt_qspi_message *)message;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rt_spi_message</span> *<span class="hljs-title">msg_parent</span> =</span> message;<br><br>    <span class="hljs-comment">/* åˆ¤æ–­æ˜¯å¦ä¸ºå¢å¼ºå‹SPIä¼ è¾“ */</span><br>    <span class="hljs-keyword">if</span> (msg-&gt;qspi_data_lines &gt; <span class="hljs-number">1</span>)<br>    &#123;<br><span class="hljs-comment">// ...</span><br>    &#125;<span class="hljs-keyword">else</span> &#123;<br><br><span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å¢å¼ºå‹SPIä¼ è¾“"><a href="#å¢å¼ºå‹SPIä¼ è¾“" class="headerlink" title="å¢å¼ºå‹SPIä¼ è¾“"></a>å¢å¼ºå‹SPIä¼ è¾“</h4><p>å¢å¼ºå‹SPIä¼ è¾“éœ€è¦æ›´å¤æ‚çš„å‚æ•°æ ¡éªŒå’Œé…ç½®ã€‚ä»£ç é¦–å…ˆéªŒè¯ä¼ è¾“å‚æ•°çš„åˆæ³•æ€§ï¼ŒåŒ…æ‹¬æ•°æ®çº¿æ•°ä¸èƒ½è¶…è¿‡ç¡¬ä»¶é…ç½®çš„æœ€å¤§å€¼ï¼Œæ•°æ®å®½åº¦å¿…é¡»ä¸çº¿æ•°åŒ¹é…ç­‰ç­‰ã€‚</p><p>ä¼ è¾“ç±»å‹<code>trans_type</code>ç”¨äºé…ç½®<code>spi_ctrlr0</code>å¯„å­˜å™¨çš„ä½2ä½ï¼Œå†³å®šæŒ‡ä»¤å’Œåœ°å€é˜¶æ®µçš„ä¼ è¾“æ¨¡å¼ã€‚å½“æŒ‡ä»¤ä½¿ç”¨å¤šçº¿ä¼ è¾“æ—¶è®¾ç½®ä¸º2ï¼Œå½“åœ°å€ä½¿ç”¨å¤šçº¿ä¼ è¾“æ—¶è®¾ç½®ä¸º1ã€‚å¦‚æœæŒ‡ä»¤å’Œåœ°å€éƒ½ä½¿ç”¨å¤šçº¿ï¼Œåˆ™ä¿æŒ<code>trans_type</code>ä¸º2ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (msg-&gt;instruction.qspi_lines != <span class="hljs-number">1</span>)&#123;<br>trans_type = <span class="hljs-number">2</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (msg-&gt;address.size)&#123;<br><span class="hljs-keyword">if</span> (msg-&gt;address.qspi_lines != <span class="hljs-number">1</span>)&#123;<br>trans_type = trans_type ? trans_type : <span class="hljs-number">1</span>;<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (trans_type != <span class="hljs-number">0</span>)&#123;<br>LOG_E(<span class="hljs-string">&quot;instruction or address line is invalid&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¢å¼ºå‹SPIä¸€èˆ¬æ¶‰åŠåˆ°å¤§é‡æ•°æ®çš„æ”¶å‘ï¼Œé©±åŠ¨é‡‡ç”¨äº†DMAä¼ è¾“æ¨¡å¼ã€‚è¿™é‡Œçš„DMAæ˜¯SPIæ§åˆ¶å™¨å†…éƒ¨çš„Internal DMAï¼Œå¹¶ä¸æ˜¯SoCçš„PDMAæ§åˆ¶å™¨ï¼Œä¸¤è€…åœ¨ç¡¬ä»¶ä¸Šå®Œå…¨ç‹¬ç«‹ï¼Œå› æ­¤SPIçš„DMAåªéœ€è¦é…ç½®æœ¬æ§åˆ¶å™¨çš„å¯„å­˜å™¨ï¼Œä¸ç”¨ç”³è¯·PDMAé€šé“ã€‚</p><p>ç”±äºè¿™ä¸ªDMAç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼ŒDMAä¼ è¾“éœ€è¦ä½¿ç”¨cacheå¯¹é½çš„ç¼“å†²åŒºã€‚å¯¹äºå‘é€æ“ä½œï¼Œé©±åŠ¨å°†ç”¨æˆ·æ•°æ®å¤åˆ¶åˆ°å¯¹é½ç¼“å†²åŒºå¹¶æ‰§è¡Œcacheæ¸…ç†æ“ä½œï¼Œç¡®ä¿æ•°æ®å†™å…¥å†…å­˜ï¼›å¯¹äºæ¥æ”¶æ“ä½œï¼Œä¼ è¾“å®Œæˆåéœ€è¦ä½¿cacheæ— æ•ˆï¼Œç„¶åå°†æ•°æ®å¤åˆ¶å›ç”¨æˆ·ç¼“å†²åŒºã€‚è¿™ç§è®¾è®¡é¿å…äº†cacheä¸€è‡´æ€§é—®é¢˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">rt_uint8_t</span> tmod = msg_parent-&gt;recv_buf ? SPI_TMOD_RO : SPI_TMOD_TO;<br><span class="hljs-type">rt_size_t</span> length = msg_parent-&gt;length;<br><span class="hljs-type">rt_size_t</span> txfthr = length &gt; (SSIC_TX_ABW / <span class="hljs-number">2</span>) ? (SSIC_TX_ABW / <span class="hljs-number">2</span>) : length - <span class="hljs-number">1</span>;<br><span class="hljs-type">rt_uint8_t</span> cell_size = (qspi_cfg_parent-&gt;data_width + <span class="hljs-number">7</span>) &gt;&gt; <span class="hljs-number">3</span>;<br><span class="hljs-type">rt_uint8_t</span> *buf = RT_NULL;<br>    <br><span class="hljs-comment">/* åˆ†é…cacheå¯¹é½çš„DMAç¼“å†²åŒº */</span><br><span class="hljs-keyword">if</span> (length)&#123;<br>buf = rt_malloc_align(CACHE_ALIGN_TOP(length * cell_size), L1_CACHE_BYTES);<br><span class="hljs-keyword">if</span> (buf == RT_NULL)&#123;<br>LOG_E(<span class="hljs-string">&quot;alloc mem error&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯„å­˜å™¨é…ç½®åŒ…æ‹¬ä¼ è¾“å‚æ•°å’ŒDMAè®¾ç½®ã€‚<code>spi_ctrlr0</code>çš„ä½2ä½æ˜¯ä¼ è¾“ç±»å‹ï¼Œç¬¬5-2ä½æ˜¯åœ°å€é•¿åº¦ï¼ˆå‘ä¸‹å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œï¼‰ï¼Œç¬¬10-8ä½ä¸º0x2åªè¯»ï¼Œç¬¬15-11ä½æ˜¯ç­‰å¾…å‘¨æœŸã€‚FIFOé˜ˆå€¼æ ¹æ®ä¼ è¾“é•¿åº¦åŠ¨æ€è°ƒæ•´ï¼Œå‘é€é˜ˆå€¼è®¾ç½®ä¸ºä¼ è¾“é•¿åº¦å’ŒFIFOæ·±åº¦ä¸€åŠçš„è¾ƒå°å€¼ï¼Œæ¥æ”¶é˜ˆå€¼è®¾ç½®ä¸ºFIFOæ·±åº¦å‡1ï¼Œä¹‹åå–æ¶ˆSSI_DONEå’ŒSSI_AXIEä¸­æ–­çš„æ©ç ï¼Œæœ€åä½¿èƒ½DMAã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* msg-&gt;address.size &amp; ~0x03:  Round address.size down to the nearest multiple of 4 and write it to ADDR_L[5:2] */</span><br>qspi_reg-&gt;spi_ctrlr0 = trans_type | (msg-&gt;address.size &amp; ~<span class="hljs-number">0x03</span>) <br>    | (<span class="hljs-number">0x2</span> &lt;&lt; <span class="hljs-number">8</span>) | (msg-&gt;dummy_cycles &lt;&lt; <span class="hljs-number">11</span>);<br>qspi_reg-&gt;ctrlr0 &amp;= ~((<span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">22</span>) | (<span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">10</span>));<br><br><span class="hljs-comment">/* Config SPI frame format and transmission mode */</span><br><span class="hljs-keyword">if</span> (length)<br>&#123;<br>qspi_reg-&gt;ctrlr0 |= (tmod &lt;&lt; <span class="hljs-number">10</span>);<br>qspi_reg-&gt;txftlr = (txfthr &lt;&lt; <span class="hljs-number">16</span>) | (SSIC_TX_ABW / <span class="hljs-number">2</span>);<br>qspi_reg-&gt;rxftlr = (SSIC_RX_ABW - <span class="hljs-number">1</span>);<br>    qspi_reg-&gt;imr = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">11</span>) | (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>);<br>    qspi_reg-&gt;dmacr = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>) | (<span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">3</span>) | (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>);<br>    qspi_reg-&gt;ctrlr1 = length - <span class="hljs-number">1</span>;<br>    qspi_reg-&gt;spidr = msg-&gt;instruction.content;<br>    qspi_reg-&gt;spiar = msg-&gt;address.content;<br>    <span class="hljs-keyword">if</span> (tmod == SPI_TMOD_TO)&#123;<br>        rt_memcpy(buf, msg_parent-&gt;send_buf, length * cell_size);<br>        rt_hw_cpu_dcache_clean(buf, CACHE_ALIGN_TOP(length * cell_size));<br>    &#125;<br>    qspi_reg-&gt;axiar0 = (<span class="hljs-type">rt_uint32_t</span>)((<span class="hljs-type">uint64_t</span>)buf);<br>    qspi_reg-&gt;axiar1 = (<span class="hljs-type">rt_uint32_t</span>)((<span class="hljs-type">uint64_t</span>)buf &gt;&gt; <span class="hljs-number">32</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºåªå‘é€æŒ‡ä»¤å’Œåœ°å€è€Œæ²¡æœ‰æ•°æ®é˜¶æ®µçš„ä¼ è¾“ï¼Œé©±åŠ¨ç¦ç”¨DMAå’Œä¸­æ–­ï¼Œç›´æ¥é€šè¿‡å†™æ•°æ®å¯„å­˜å™¨å‘é€æŒ‡ä»¤å’Œåœ°å€ï¼Œç„¶åè½®è¯¢çŠ¶æ€å¯„å­˜å™¨ç­‰å¾…ä¼ è¾“å®Œæˆã€‚è¿™ç§æ–¹å¼é¿å…äº†ä¸ºçŸ­ä¼ è¾“åˆ†é…DMAç¼“å†²åŒºå’Œå¤„ç†ä¸­æ–­çš„å¼€é”€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span>&#123;<br>    tmod = SPI_TMOD_TO;<br>    qspi_reg-&gt;ctrlr0 |= (tmod &lt;&lt; <span class="hljs-number">10</span>);<br>    qspi_reg-&gt;txftlr = ((SSIC_TX_ABW - <span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-number">16</span>) | (SSIC_TX_ABW - <span class="hljs-number">1</span>);<br>    qspi_reg-&gt;rxftlr = (SSIC_RX_ABW - <span class="hljs-number">1</span>);<br>    qspi_reg-&gt;imr = <span class="hljs-number">0</span>;<br>    qspi_reg-&gt;dmacr = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼ è¾“æ‰§è¡Œæ—¶å…ˆå¤ä½äº‹ä»¶ï¼Œç„¶åä½¿èƒ½ç‰‡é€‰å’Œæ§åˆ¶å™¨ã€‚æœ‰æ•°æ®ä¼ è¾“æ—¶ç­‰å¾…ä¸­æ–­äº‹ä»¶ï¼›æ— æ•°æ®ä¼ è¾“æ—¶ç›´æ¥å†™FIFOå¹¶è½®è¯¢ç­‰å¾…ã€‚ä¼ è¾“å®Œæˆåé‡Šæ”¾ç‰‡é€‰å¹¶ç¦ç”¨æ§åˆ¶å™¨ï¼Œæ£€æŸ¥è¶…æ—¶å’ŒDMAé”™è¯¯ï¼Œæœ€åå¤„ç†æ¥æ”¶æ•°æ®å¹¶é‡Šæ”¾ç¼“å†²åŒºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c">rt_event_control(&amp;qspi_bus-&gt;event, RT_IPC_CMD_RESET, <span class="hljs-number">0</span>);<br><br>qspi_reg-&gt;ser = <span class="hljs-number">1</span>;<br>qspi_reg-&gt;ssienr = <span class="hljs-number">1</span>;<br><span class="hljs-type">rt_uint32_t</span> event;<br><span class="hljs-type">rt_err_t</span> err;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Config QSPI address and instruction,</span><br><span class="hljs-comment"> * if data is empty, unable dma and send address and instruction by write data register.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (length)&#123;<br>    err = rt_event_recv(&amp;qspi_bus-&gt;event, BIT(SSI_DONE) | BIT(SSI_AXIE),<br>                                RT_EVENT_FLAG_OR | RT_EVENT_FLAG_CLEAR, <span class="hljs-number">1000</span>, &amp;event);<br>&#125;<span class="hljs-keyword">else</span><br>&#123;<br>    err = RT_EOK;<br>    event = <span class="hljs-number">0</span>;<br>    qspi_reg-&gt;dr[<span class="hljs-number">0</span>] = msg-&gt;instruction.content;<br>    length++;<br>    <span class="hljs-keyword">if</span> (msg-&gt;address.size)&#123;<br>        qspi_reg-&gt;dr[<span class="hljs-number">0</span>] = msg-&gt;address.content;<br>        length++;<br>    &#125;<br>    qspi_reg-&gt;txftlr = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">/* Wait for SPI transfer to complete (busy-wait) */</span><br>    <span class="hljs-keyword">while</span> ((qspi_reg-&gt;sr &amp; <span class="hljs-number">0x5</span>) != <span class="hljs-number">0x4</span>)<br>    &#123;<br>        <span class="hljs-comment">/* Busy wait */</span><br>    &#125;<br>&#125;<br>qspi_reg-&gt;ser = <span class="hljs-number">0</span>;<br>qspi_reg-&gt;ssienr = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (err == -RT_ETIMEOUT)&#123;<br>    LOG_E(<span class="hljs-string">&quot;qspi%d transfer data timeout&quot;</span>, qspi_bus-&gt;idx);<br>    <span class="hljs-keyword">if</span> (buf)&#123;<br>        rt_free_align(buf);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (event &amp; BIT(SSI_AXIE))&#123;<br>    LOG_E(<span class="hljs-string">&quot;qspi%d dma error&quot;</span>, qspi_bus-&gt;idx);<br>    <span class="hljs-keyword">if</span> (buf)&#123;<br>        rt_free_align(buf);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">/* Read data from FIFO */</span><br><span class="hljs-keyword">if</span> (tmod == SPI_TMOD_RO)&#123;<br>    rt_hw_cpu_dcache_invalidate(buf, CACHE_ALIGN_TOP(length * cell_size));<br>    rt_memcpy(msg_parent-&gt;recv_buf, buf, length * cell_size);<br>&#125;<br><span class="hljs-keyword">if</span> (buf)&#123;<br>    rt_free_align(buf);<br>&#125;<br><span class="hljs-keyword">return</span> length;<br><br></code></pre></td></tr></table></figure><h4 id="æ ‡å‡†SPIä¼ è¾“"><a href="#æ ‡å‡†SPIä¼ è¾“" class="headerlink" title="æ ‡å‡†SPIä¼ è¾“"></a>æ ‡å‡†SPIä¼ è¾“</h4><p>æ ‡å‡†SPIä¼ è¾“ä½¿ç”¨ä¸­æ–­æ–¹å¼è€ŒéDMAã€‚é©±åŠ¨é¦–å…ˆæ ¹æ®ç¼“å†²åŒºæ˜¯å¦ç©ºç¡®å®šä¼ è¾“æ¨¡å¼ï¼šåªæœ‰å‘é€ç¼“å†²åŒºæ—¶ä¸ºåªå‘é€æ¨¡å¼ï¼ˆ<code>SPI_TMOD_TO</code>ï¼‰ï¼Œåªæœ‰æ¥æ”¶ç¼“å†²åŒºæ—¶ä¸ºåªè¯»æ¨¡å¼ï¼ˆ<code>SPI_TMOD_RO</code>ï¼‰ï¼Œä¸¤è€…éƒ½æœ‰æ—¶ä¸ºå…¨åŒå·¥æ¨¡å¼ï¼ˆ<code>SPI_TMOD_TR</code>ï¼‰ã€‚å¯¹äºåªè¯»æ¨¡å¼ï¼Œå¦‚æœé…ç½®äº†åœ°å€ï¼Œåˆ™åˆ‡æ¢ä¸ºEEPROMè¯»æ¨¡å¼ï¼ˆ<code>SPI_TMOD_EPROMREAD</code>ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (msg_parent-&gt;length == <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-type">rt_uint8_t</span> cell_size = (qspi_cfg_parent-&gt;data_width + <span class="hljs-number">7</span>) &gt;&gt; <span class="hljs-number">3</span>;<br><span class="hljs-type">rt_size_t</span> length = msg_parent-&gt;length;<br><span class="hljs-type">rt_size_t</span> count = length &gt; <span class="hljs-number">0x10000</span> ? <span class="hljs-number">0x10000</span> : length;<br><span class="hljs-type">rt_size_t</span> send_single = <span class="hljs-number">0</span>, send_length = <span class="hljs-number">0</span>, recv_single = <span class="hljs-number">0</span>, recv_length = <span class="hljs-number">0</span>;<br><span class="hljs-type">void</span> *send_buf = (<span class="hljs-type">void</span> *)msg_parent-&gt;send_buf;<br><span class="hljs-type">void</span> *recv_buf = msg_parent-&gt;recv_buf;<br><span class="hljs-type">rt_uint8_t</span> tmod = send_buf ? SPI_TMOD_TO : SPI_TMOD_EPROMREAD;<br>tmod = recv_buf ? tmod &amp; SPI_TMOD_RO : tmod;<br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">if</span> (tmod == SPI_TMOD_RO &amp;&amp; qspi_cfg_parent-&gt;data_width == <span class="hljs-number">8</span>)&#123;<br>    <span class="hljs-keyword">if</span> ((msg-&gt;address.size &amp; <span class="hljs-number">7</span>) || (msg-&gt;dummy_cycles &amp; <span class="hljs-number">7</span>))&#123;<br>        <span class="hljs-comment">// error message</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg-&gt;address.size)&#123;<br>        <span class="hljs-keyword">if</span> (length &gt; <span class="hljs-number">0x10000</span>)&#123;<br>            <span class="hljs-comment">// error message</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        tmod = SPI_TMOD_EPROMREAD;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼“å†²åŒºå‡†å¤‡æ—¶ï¼Œé©±åŠ¨ä¸ºå‘é€å’Œæ¥æ”¶åˆ†åˆ«åˆ†é…ä¸´æ—¶ç¼“å†²åŒºã€‚å¯¹äºEEPROMè¯»æ¨¡å¼ï¼Œéœ€è¦æ„é€ åŒ…å«æŒ‡ä»¤ã€åœ°å€å’Œdummyå­—èŠ‚çš„å‘é€åºåˆ—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (send_buf)&#123;<br>    send_single = count;<br>    send_buf = rt_malloc(count * cell_size);<br>    <span class="hljs-keyword">if</span> (send_buf == RT_NULL)&#123;<br>        LOG_E(<span class="hljs-string">&quot;alloc mem error&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    rt_memcpy(send_buf, msg_parent-&gt;send_buf, count * cell_size);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tmod == SPI_TMOD_EPROMREAD)&#123;<br>    send_single = <span class="hljs-number">1</span> + msg-&gt;address.size / <span class="hljs-number">8</span> + msg-&gt;dummy_cycles / <span class="hljs-number">8</span>;<br>    send_buf = rt_malloc(send_single);<br>    <span class="hljs-keyword">if</span> (send_buf == RT_NULL)<br>    &#123;<br>        LOG_E(<span class="hljs-string">&quot;alloc mem error&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-type">rt_uint8_t</span> *temp = send_buf;<br>    *temp++ = msg-&gt;instruction.content;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = msg-&gt;address.size / <span class="hljs-number">8</span>; i; i--)&#123;<br>        *temp++ = msg-&gt;address.content &gt;&gt; ((i - <span class="hljs-number">1</span>) * <span class="hljs-number">8</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = msg-&gt;dummy_cycles / <span class="hljs-number">8</span>; i; i--)&#123;<br>        *temp++ = <span class="hljs-number">0xFF</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ç¼“å†²åŒºå‡†å¤‡å®Œæˆåï¼Œé©±åŠ¨éœ€è¦é…ç½®å¯„å­˜å™¨å¹¶å¯åŠ¨ä¼ è¾“ã€‚é¦–å…ˆå°†ç¼“å†²åŒºä¿¡æ¯ä¿å­˜åˆ°è®¾å¤‡ç»“æ„ä½“ä¸­ï¼Œä¾›ä¸­æ–­å¤„ç†å‡½æ•°ä½¿ç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">qspi_bus-&gt;cell_size = cell_size;<br>qspi_bus-&gt;send_buf = send_buf;<br>qspi_bus-&gt;recv_buf = recv_buf;<br>qspi_bus-&gt;send_length = send_single;<br>qspi_bus-&gt;recv_length = recv_single;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥é…ç½®ä¼ è¾“ç›¸å…³å¯„å­˜å™¨ã€‚<code>ctrlr0</code>è®¾ç½®ä¼ è¾“æ¨¡å¼ï¼Œ<code>ctrlr1</code>è®¾ç½®æœ¬æ¬¡ä¼ è¾“çš„æ•°æ®é•¿åº¦ã€‚FIFOé˜ˆå€¼é…ç½®å’Œå¢å¼ºå‹SPIç±»ä¼¼ï¼šå‘é€é˜ˆå€¼è®¾ä¸ºFIFOæ·±åº¦çš„ä¸€åŠï¼Œæ¥æ”¶é˜ˆå€¼æ ¹æ®ä¼ è¾“é•¿åº¦åŠ¨æ€è°ƒæ•´ã€‚ç¦ç”¨DMAï¼Œä½¿èƒ½å‘é€ç©ºå’Œæ¥æ”¶æ»¡ä¸­æ–­ï¼Œé…ç½®å®Œæˆåï¼Œå¤ä½äº‹ä»¶æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶çŠ¶æ€ï¼Œç„¶åæ‹‰ä½ç‰‡é€‰å¹¶ä½¿èƒ½æ§åˆ¶å™¨å¯åŠ¨ä¼ è¾“ã€‚å¯¹äºåªè¯»æ¨¡å¼ï¼Œéœ€è¦å‘æ•°æ®å¯„å­˜å™¨å†™å…¥ä¸€ä¸ªdummyå€¼æ¥è§¦å‘è¯»æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">qspi_reg-&gt;ctrlr0 &amp;= ~((<span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">22</span>) | (<span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">10</span>));<br>qspi_reg-&gt;ctrlr0 |= (tmod &lt;&lt; <span class="hljs-number">10</span>);<br>qspi_reg-&gt;ctrlr1 = count - <span class="hljs-number">1</span>;<br>qspi_reg-&gt;txftlr = ((SSIC_TX_ABW / <span class="hljs-number">2</span>) &lt;&lt; <span class="hljs-number">16</span>) | (SSIC_TX_ABW / <span class="hljs-number">2</span>);<br>qspi_reg-&gt;rxftlr = count &gt;= (SSIC_RX_ABW / <span class="hljs-number">2</span>) ? (SSIC_RX_ABW / <span class="hljs-number">2</span> - <span class="hljs-number">1</span>) : count - <span class="hljs-number">1</span>;<br>qspi_reg-&gt;dmacr = <span class="hljs-number">0</span>;<br><span class="hljs-comment">/* Interrupt transmit or receive */</span><br>qspi_reg-&gt;imr = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>) | (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>);<br>rt_event_control(&amp;qspi_bus-&gt;event, RT_IPC_CMD_RESET, <span class="hljs-number">0</span>);<br>qspi_reg-&gt;ser = <span class="hljs-number">1</span>;<br>qspi_reg-&gt;ssienr = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">if</span> (tmod == SPI_TMOD_RO)<br>    qspi_reg-&gt;dr[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>ä¼ è¾“çº¿ç¨‹åœ¨é…ç½®å®Œå¯„å­˜å™¨å¹¶å¯åŠ¨ä¼ è¾“åï¼Œè¿›å…¥äº‹ä»¶å¾ªç¯é€šè¿‡<code>rt_event_recv</code>é˜»å¡ç­‰å¾…ä¸­æ–­äº‹ä»¶ã€‚è¿™ä¸ªå‡½æ•°ä¼šæŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æ¥æ”¶åˆ°æŒ‡å®šçš„äº‹ä»¶æˆ–è¶…æ—¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span> (RT_TRUE)&#123;<br>    <span class="hljs-type">rt_uint32_t</span> event;<br>    <span class="hljs-type">rt_err_t</span> err = rt_event_recv(&amp;qspi_bus-&gt;event, <br>                                 BIT(SSI_TXE) | BIT(SSI_RXF),<br>                                 RT_EVENT_FLAG_OR | RT_EVENT_FLAG_CLEAR, <br>                                 <span class="hljs-number">10000</span>, &amp;event);<br><span class="hljs-comment">// ...æ”¶å‘é€»è¾‘</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>å½“æ”¶åˆ°SSI_TXEäº‹ä»¶æ—¶ï¼Œè¡¨ç¤ºå½“å‰æ‰¹æ¬¡çš„æ•°æ®å·²ç»å…¨éƒ¨å†™å…¥FIFOã€‚å¦‚æœè¿˜æœ‰å‰©ä½™æ•°æ®éœ€è¦å‘é€ï¼Œé©±åŠ¨å°†ä¸‹ä¸€æ‰¹æ•°æ®ï¼ˆæœ€å¤š64KBï¼‰å¤åˆ¶åˆ°ä¸´æ—¶ç¼“å†²åŒºï¼Œæ›´æ–°è®¾å¤‡ç»“æ„ä½“ä¸­çš„ç¼“å†²åŒºæŒ‡é’ˆå’Œé•¿åº¦ï¼Œç„¶åé‡æ–°ä½¿èƒ½SSI_TXEä¸­æ–­ã€‚å¯¹äºåªå‘é€æ¨¡å¼ï¼Œå½“æ‰€æœ‰æ•°æ®éƒ½å·²å‘é€åï¼Œéœ€è¦è½®è¯¢çŠ¶æ€å¯„å­˜å™¨ç­‰å¾…SPIæ§åˆ¶å™¨å®Œæˆç‰©ç†ä¼ è¾“ï¼Œå› ä¸ºæœ€åä¸€æ‰¹æ•°æ®å¯èƒ½è¿˜åœ¨FIFOä¸­ç­‰å¾…å‘é€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Handle Transmit buffer empty */</span><br><span class="hljs-keyword">if</span> (event &amp; BIT(SSI_TXE))&#123;<br>    send_length += send_single;<br>    <span class="hljs-keyword">if</span> (send_length &lt; length &amp;&amp; tmod &lt;= SPI_TMOD_TO)&#123;<br>        count = length - send_length;<br>        count = count &gt; <span class="hljs-number">0x10000</span> ? <span class="hljs-number">0x10000</span> : count;<br>        rt_memcpy(send_buf, msg_parent-&gt;send_buf + send_length * cell_size, count * cell_size);<br>        qspi_bus-&gt;send_buf = send_buf;<br>        qspi_bus-&gt;send_length = count;<br>        send_single = count;<br>        qspi_reg-&gt;txftlr = ((SSIC_TX_ABW / <span class="hljs-number">2</span>) &lt;&lt; <span class="hljs-number">16</span>) | (SSIC_TX_ABW / <span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">if</span> (tmod == SPI_TMOD_TO)<br>            qspi_reg-&gt;imr |= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tmod == SPI_TMOD_TO)<br>    &#123;<br>        <span class="hljs-comment">/* Wait for SPI transfer to complete (busy-wait) */</span><br>        <span class="hljs-keyword">while</span> ((qspi_reg-&gt;sr &amp; <span class="hljs-number">0x5</span>) != <span class="hljs-number">0x4</span>)<br>        &#123;<br>            <span class="hljs-comment">/* Busy wait */</span><br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æ”¶åˆ°SSI_RXFäº‹ä»¶æ—¶ï¼Œè¡¨ç¤ºä¸´æ—¶ç¼“å†²åŒºå·²ç»æ¥æ”¶æ»¡ã€‚é©±åŠ¨å°†æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·ç¼“å†²åŒºï¼Œæ›´æ–°å·²æ¥æ”¶çš„æ•°æ®é‡ã€‚å¦‚æœè¿˜æœ‰å‰©ä½™æ•°æ®éœ€è¦æ¥æ”¶ï¼Œå‡†å¤‡æ¥æ”¶ä¸‹ä¸€æ‰¹æ•°æ®ã€‚å¯¹äºåªè¯»æ¨¡å¼ï¼Œæ¯æ¬¡åªèƒ½é…ç½®ä¸€æ¬¡æ¥æ”¶é•¿åº¦ï¼ˆé€šè¿‡<code>ctrlr1</code>å¯„å­˜å™¨ï¼‰ï¼Œå› æ­¤éœ€è¦ç¦ç”¨æ§åˆ¶å™¨ã€æ›´æ–°<code>ctrlr1</code>ã€é‡æ–°ä½¿èƒ½æ§åˆ¶å™¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Handle receive buffer full */</span><br><span class="hljs-keyword">if</span> (event &amp; BIT(SSI_RXF))&#123;<br>    rt_memcpy(msg_parent-&gt;recv_buf + recv_length * cell_size, recv_buf, recv_single * cell_size);<br>    recv_length += recv_single;<br>    <span class="hljs-keyword">if</span> (recv_length &gt;= length)<br>    &#123;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    count = length - recv_length;<br>    count = count &gt; <span class="hljs-number">0x10000</span> ? <span class="hljs-number">0x10000</span> : count;<br>    qspi_bus-&gt;recv_buf = recv_buf;<br>    qspi_bus-&gt;recv_length = count;<br>    recv_single = count;<br>    qspi_reg-&gt;rxftlr = count &gt;= (SSIC_RX_ABW / <span class="hljs-number">2</span>) ? (SSIC_RX_ABW / <span class="hljs-number">2</span> - <span class="hljs-number">1</span>) : count - <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (tmod == SPI_TMOD_TR)&#123;<br>        qspi_reg-&gt;imr |= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>) | (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tmod == SPI_TMOD_RO)&#123;<br>        qspi_reg-&gt;imr |= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>);<br>        qspi_reg-&gt;ssienr = <span class="hljs-number">0</span>;<br>        qspi_reg-&gt;ctrlr1 = count - <span class="hljs-number">1</span>;<br>        qspi_reg-&gt;ssienr = <span class="hljs-number">1</span>;<br>        <span class="hljs-comment">/* Trigger two dummy transfers to restart SPI read in read-only mode.</span><br><span class="hljs-comment">         * This is required by the hardware to ensure correct data reception.</span><br><span class="hljs-comment">         */</span><br>        qspi_reg-&gt;dr[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>        qspi_reg-&gt;dr[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸­æ–­å›è°ƒå‡½æ•°"><a href="#ä¸­æ–­å›è°ƒå‡½æ•°" class="headerlink" title="ä¸­æ–­å›è°ƒå‡½æ•°"></a>ä¸­æ–­å›è°ƒå‡½æ•°</h3><p>ä¸­æ–­å›è°ƒå‡½æ•°æ˜¯æ ‡å‡†SPIä¼ è¾“çš„æ ¸å¿ƒï¼Œè´Ÿè´£å®é™…çš„FIFOè¯»å†™æ“ä½œã€‚å‡½æ•°é€šè¿‡ä¸­æ–­å‘é‡å·è¯†åˆ«ä¸­æ–­ç±»å‹ï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚</p><p>K230çš„æ¯ä¸ªSPIæ§åˆ¶å™¨æœ‰4ä¸ªä¸­æ–­æºï¼Œå®ƒä»¬çš„ä¸­æ–­å‘é‡å·æ˜¯è¿ç»­çš„ã€‚é€šè¿‡è®¡ç®—å‘é‡å·ç›¸å¯¹äºIRQN_SPI0åŸºå€çš„åç§»ï¼Œå¯ä»¥ç¡®å®šæ˜¯å“ªä¸ªæ§åˆ¶å™¨çš„å“ªç§ä¸­æ–­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">k230_spi_irq</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-built_in">vector</span>, <span class="hljs-type">void</span> *param)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">k230_spi_dev</span> *<span class="hljs-title">qspi_bus</span> =</span> param;<br>    <span class="hljs-type">k230_spi_reg_t</span> *qspi_reg = (<span class="hljs-type">k230_spi_reg_t</span> *)qspi_bus-&gt;base;<br>    <br><br>    <span class="hljs-built_in">vector</span> -= IRQN_SPI0;<br>    <span class="hljs-built_in">vector</span> %= (IRQN_SPI1 - IRQN_SPI0);<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>å½“å‘é€FIFOä¸­çš„æ•°æ®é‡ä½äºé˜ˆå€¼æ—¶è§¦å‘SSI_TXEä¸­æ–­ã€‚ä¸­æ–­å¤„ç†å‡½æ•°æ£€æŸ¥çŠ¶æ€å¯„å­˜å™¨srçš„bit1ï¼ˆTx FIFO FULLï¼‰ï¼Œå¾ªç¯å°†æ•°æ®å†™å…¥FIFOç›´åˆ°ç¼“å†²åŒºä¸ºç©ºæˆ–FIFOæ»¡ã€‚æ ¹æ®<code>cell_size</code>ï¼ˆæ•°æ®å¸§å¤§å°ï¼‰é€‰æ‹©8ä½ã€16ä½æˆ–32ä½å†™å…¥æ–¹å¼ã€‚</p><p>å½“ç¼“å†²åŒºæ•°æ®å…¨éƒ¨å†™å…¥FIFOåï¼Œå¤„ç†é€»è¾‘æ ¹æ®ä¼ è¾“æ¨¡å¼æœ‰æ‰€ä¸åŒã€‚å¯¹äºåªå‘é€æ¨¡å¼ï¼ˆ<code>SPI_TMOD_TO</code>ï¼‰ï¼Œæ•°æ®å…¨éƒ¨å†™å…¥FIFOå¹¶ä¸æ„å‘³ç€ä¼ è¾“å®Œæˆï¼Œå› ä¸ºFIFOä¸­çš„æ•°æ®å¯èƒ½è¿˜åœ¨ç­‰å¾…å‘é€ã€‚é©±åŠ¨å°†å‘é€é˜ˆå€¼è®¾ä¸º0ï¼Œè¿™æ ·å½“FIFOå®Œå…¨æ¸…ç©ºæ—¶ä¼šå†æ¬¡è§¦å‘TXEä¸­æ–­ï¼Œæ­¤æ—¶æ‰å‘é€äº‹ä»¶é€šçŸ¥ä¼ è¾“çº¿ç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Handle transmit buffer empty interrupt */</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">vector</span> == SSI_TXE)&#123;<br>    <span class="hljs-keyword">if</span> (qspi_bus-&gt;send_buf == RT_NULL)&#123;<br>        qspi_reg-&gt;imr &amp;= ~<span class="hljs-number">1</span>;<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (qspi_bus-&gt;cell_size == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">while</span> ((qspi_bus-&gt;send_length) &amp;&amp; (qspi_reg-&gt;sr &amp; <span class="hljs-number">2</span>))&#123;<br>            qspi_reg-&gt;dr[<span class="hljs-number">0</span>] = *((<span class="hljs-type">rt_uint8_t</span> *)qspi_bus-&gt;send_buf);<br>            qspi_bus-&gt;send_buf++;<br>            qspi_bus-&gt;send_length--;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// cell_size = 2/4</span><br>    <span class="hljs-keyword">if</span> (qspi_bus-&gt;send_length == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">if</span> (((qspi_reg-&gt;ctrlr0 &gt;&gt; <span class="hljs-number">10</span>) &amp; SPI_TMOD_EPROMREAD) == SPI_TMOD_TO)&#123;<br>            <span class="hljs-keyword">if</span> (qspi_reg-&gt;txftlr)<br>                <span class="hljs-keyword">return</span>;<br>        &#125;<br>        qspi_reg-&gt;txftlr = <span class="hljs-number">0</span>;<br>        qspi_reg-&gt;imr &amp;= ~<span class="hljs-number">1</span>;<br>        rt_event_send(&amp;qspi_bus-&gt;event, BIT(SSI_TXE));<br>    &#125;<br>&#125;<br>   <br></code></pre></td></tr></table></figure><p>å½“æ¥æ”¶FIFOä¸­çš„æ•°æ®é‡è¾¾åˆ°é˜ˆå€¼æ—¶è§¦å‘SSI_RXFä¸­æ–­ã€‚ä¸­æ–­å¤„ç†å‡½æ•°æ£€æŸ¥çŠ¶æ€å¯„å­˜å™¨srçš„bit3ï¼ˆReceive FIFO EMPTYï¼‰ï¼Œå¾ªç¯ä»FIFOè¯»å–æ•°æ®ç›´åˆ°ç¼“å†²åŒºæ»¡æˆ–FIFOç©ºã€‚åŒæ ·æ ¹æ®<code>cell_size</code>é€‰æ‹©è¯»å–æ–¹å¼ã€‚</p><p>å½“å‰©ä½™æ•°æ®é‡å°äºå½“å‰FIFOé˜ˆå€¼æ—¶ï¼ŒåŠ¨æ€è°ƒæ•´é˜ˆå€¼é¿å…æœ€åä¸€æ‰¹æ•°æ®æ— æ³•è§¦å‘ä¸­æ–­ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé˜ˆå€¼è®¾ä¸º31ï¼ˆFIFOæ·±åº¦çš„ä¸€åŠï¼‰ï¼Œä½†åªå‰©20ä¸ªæ•°æ®è¦æ¥æ”¶ï¼ŒFIFOæ°¸è¿œä¸ä¼šè¾¾åˆ°31çš„é˜ˆå€¼ï¼Œå¯¼è‡´æ¥æ”¶å¡æ­»ã€‚å°†é˜ˆå€¼è°ƒæ•´ä¸º19ï¼ˆå‰©ä½™æ•°æ®-1ï¼‰å¯ä»¥ç¡®ä¿æœ€åä¸€æ‰¹æ•°æ®æ­£ç¡®æ¥æ”¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">vector</span> == SSI_RXF)&#123;<br>    <span class="hljs-keyword">if</span> (qspi_bus-&gt;recv_buf == RT_NULL)&#123;<br>        qspi_reg-&gt;imr &amp;= ~<span class="hljs-number">0x10</span>;<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (qspi_bus-&gt;cell_size == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">while</span> ((qspi_bus-&gt;recv_length) &amp;&amp; (qspi_reg-&gt;sr &amp; <span class="hljs-number">8</span>))&#123;<br>            *((<span class="hljs-type">rt_uint8_t</span> *)qspi_bus-&gt;recv_buf) = qspi_reg-&gt;dr[<span class="hljs-number">0</span>];<br>            qspi_bus-&gt;recv_buf++;<br>            qspi_bus-&gt;recv_length--;<br>        &#125;<br>    &#125;<br><span class="hljs-comment">// cell_size = 2/4</span><br>    <span class="hljs-keyword">if</span> (qspi_bus-&gt;recv_length == <span class="hljs-number">0</span>)&#123;<br>        qspi_reg-&gt;imr &amp;= ~<span class="hljs-number">0x10</span>;<br>        rt_event_send(&amp;qspi_bus-&gt;event, BIT(SSI_RXF));<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (qspi_bus-&gt;recv_length &lt;= qspi_reg-&gt;rxftlr)&#123;<br>        qspi_reg-&gt;rxftlr = qspi_bus-&gt;recv_length - <span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼ è¾“å®Œæˆä¸­æ–­ï¼ˆDONEï¼‰å’ŒAXIé”™è¯¯ä¸­æ–­ï¼ˆAXIEï¼‰ä¸»è¦ç”¨äºå¢å¼ºå‹SPIçš„DMAä¼ è¾“æ¨¡å¼ã€‚ä¸­æ–­å¤„ç†å‡½æ•°åªéœ€è¯»å–ç›¸åº”çš„æ¸…é™¤å¯„å­˜å™¨æ¥æ¸…é™¤ä¸­æ–­æ ‡å¿—ï¼Œç„¶åå‘é€äº‹ä»¶é€šçŸ¥ä¼ è¾“çº¿ç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">vector</span> == SSI_DONE)&#123;<br>    (<span class="hljs-type">void</span>)qspi_reg-&gt;donecr;  <span class="hljs-comment">// è¯»å–æ¸…é™¤ä¸­æ–­</span><br>    rt_event_send(&amp;qspi_bus-&gt;event, BIT(SSI_DONE));<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">vector</span> == SSI_AXIE)&#123;<br>    (<span class="hljs-type">void</span>)qspi_reg-&gt;axiecr;  <span class="hljs-comment">// è¯»å–æ¸…é™¤ä¸­æ–­</span><br>    rt_event_send(&amp;qspi_bus-&gt;event, BIT(SSI_AXIE));<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸­æ–­è§¦å‘æ—¶ä¼šå±è”½è°ƒåº¦å™¨ï¼Œå¯¼è‡´æ“ä½œç³»ç»Ÿæ— æ³•è¿›è¡Œæ­£å¸¸çš„ä»»åŠ¡è°ƒåº¦ã€‚å› æ­¤é©±åŠ¨è®¾è®¡æ—¶ï¼Œä¸­æ–­å¤„ç†å‡½æ•°åº”è¯¥å°½é‡è½»é‡ï¼Œåªåšå¿…è¦çš„FIFOè¯»å†™ç­‰æ“ä½œï¼Œé€šè¿‡äº‹ä»¶é€šçŸ¥æœºåˆ¶è§¦å‘ä¼ è¾“çº¿ç¨‹å¤„ç†è€—æ—¶æ“ä½œã€‚</p>]]></content>
    
    
    <categories>
      
      <category>K230-rt-smart</category>
      
    </categories>
    
    
    <tags>
      
      <tag>K230</tag>
      
      <tag>rt-smart</tag>
      
      <tag>åµŒå…¥å¼</tag>
      
      <tag>bsp</tag>
      
      <tag>spi</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>K230-å¼€å‘ç¯å¢ƒæ­å»º</title>
    <link href="/2025/12/12/K230-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <url>/2025/12/12/K230-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h2 id="ç¡¬ä»¶ä»‹ç»"><a href="#ç¡¬ä»¶ä»‹ç»" class="headerlink" title="ç¡¬ä»¶ä»‹ç»"></a>ç¡¬ä»¶ä»‹ç»</h2><p>K230èŠ¯ç‰‡å¤§è‡´æ¡†å›¾å¦‚ä¸‹ï¼Œå›¾æº<a href="https://kendryte-download.canaan-creative.com/developer/k230/HDK/K230%E7%A1%AC%E4%BB%B6%E6%96%87%E6%A1%A3/K230_Technical_Reference_Manual_V0.3.1_20241118.pdf">K230æŠ€æœ¯å‚è€ƒæ‰‹å†Œ</a></p><p><img src="/2025/12/12/K230-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/image-20251212195138057.png" alt="K230èŠ¯ç‰‡æ¶æ„"></p><p>æ ¸å¿ƒæ˜¯ä¸¤é¢—ç„é“RISC-V C908ï¼Œä¸€ä¸ª800MHzçš„å°æ ¸<code>cpu0</code>ï¼Œ1.6GHzçš„å¤§æ ¸<code>cpu1</code>ã€‚å˜‰æ¥ å®˜æ–¹ç»™äº†ä¸¤ç§å¼€å‘æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯å°æ ¸<code>cpu0</code>è·‘Linuxï¼Œå¤§æ ¸<code>cpu1</code>è·‘rt-smartçš„å¼‚æ„æ¶æ„ï¼Œå¦ä¸€ç§æ˜¯çº¯rt-smartæ¶æ„ï¼Œä¼¼ä¹åªè·‘åœ¨å¤§æ ¸ä¸Šã€‚ç”±äºå¤šæ ¸é€šä¿¡å¾ˆéº»çƒ¦ï¼Œæˆ‘åªç”¨äº†rt-smartç‰ˆæœ¬è¿›è¡Œå¼€å‘ã€‚</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>k230 rt-smartå¼€å‘ç¯å¢ƒé…ç½®éœ€è¦ä¸¤å¥—ï¼Œä¸€å¥—æ˜¯<code>rt-thread</code>ä¸»çº¿å†…æ ¸ï¼Œå¦ä¸€å¥—æ˜¯åŸºç¡€é•œåƒã€‚</p><h3 id="rt-threadå†…æ ¸ç¯å¢ƒ"><a href="#rt-threadå†…æ ¸ç¯å¢ƒ" class="headerlink" title="rt-threadå†…æ ¸ç¯å¢ƒ"></a>rt-threadå†…æ ¸ç¯å¢ƒ</h3><p>ç›®å‰rt-smartçš„é•œåƒæ„å»ºåªæ”¯æŒåœ¨Linuxä¸­è¿›è¡Œï¼Œæœ¬äººæ˜¯åœ¨wsl2çš„ubuntu22.04ä¸‹æ­å»ºå¼€å‘ç¯å¢ƒçš„ï¼Œç›¸æ¯”äºè™šæ‹Ÿæœºç¨å¾®éº»çƒ¦ä¸€äº›ï¼Œä½†æ˜¯æ€§èƒ½ä¼šç›¸å¯¹å¥½ä¸€äº›ï¼Œå½“ç„¶æœ‰èƒ½åŠ›è¿˜æ˜¯ç›´æ¥Linuxç‰©ç†æœºäº†ã€‚</p><p>å…·ä½“é…ç½®æµç¨‹å‚è€ƒ<a href="https://github.com/RT-Thread/rt-thread/tree/master/bsp/k230">rt-thread K230ä¸»çº¿BSP</a>ï¼Œç®€å•çš„æµç¨‹è¿™é‡Œä¸€ç¬”å¸¦è¿‡ï¼Œé‡ç‚¹è¯´æ˜è¸©è¿‡çš„ä¸€äº›å‘:</p><p>é¦–å…ˆæ˜¯GCCå·¥å…·é“¾ï¼š<a href="https://download.rt-thread.org/rt-smart/riscv64/riscv64-linux-musleabi_for_x86_64-pc-linux-gnu_251248.tar.bz2">https://download.rt-thread.org/rt-smart/riscv64/riscv64-linux-musleabi_for_x86_64-pc-linux-gnu_251248.tar.bz2</a> ï¼Œè§£å‹å®Œæˆååœ¨<code>~/.bashrc</code>ä¸­å†™å…¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> RTT_CC=<span class="hljs-string">&quot;gcc&quot;</span><br><span class="hljs-built_in">export</span> RTT_CC_PREFIX=<span class="hljs-string">&quot;riscv64-unknown-linux-musl-&quot;</span><br><span class="hljs-built_in">export</span> RTT_EXEC_PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$USER</span>/toolchain/riscv64-linux-musleabi_for_x86_64-pc-linux-gnu/bin&quot;</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ä¸€äº›åŒ…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt install -y scons python3-pip u-boot-tools patch<br>pip3 install kconfiglib pycryptodome gmssl<br></code></pre></td></tr></table></figure><p>å®‰è£…rt-smartæ‰€éœ€ç¯å¢ƒï¼ˆé¿å…åœ¨<code>rt-thread</code>ä»“åº“ç›®å½•ä¸‹æ‰§è¡Œï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://gitee.com/RT-Thread-Mirror/env/raw/master/install_ubuntu.sh<br><span class="hljs-built_in">chmod</span> 777 install_ubuntu.sh<br>./install_ubuntu.sh --gitee<br><span class="hljs-built_in">rm</span> install_ubuntu.sh<br></code></pre></td></tr></table></figure><p>ä¸‹è½½æºç å¹¶é…ç½®ç¯å¢ƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> git@github.com:RT-Thread/rt-thread.git<br><span class="hljs-built_in">cd</span> rt-thread/bsp/k230<br><span class="hljs-built_in">source</span> ~/.env/env.sh<br>pkgs --update<br></code></pre></td></tr></table></figure><p>è¿˜æœ‰<a href="https://github.com/plctlab/rttpkgtool/tree/for-k230">rttpkgtool</a>ç”¨äºå¯¹å†…æ ¸æ–‡ä»¶è¿›è¡Œæ‰“åŒ…ï¼Œæ³¨æ„æ˜¯<code>for-k230</code>åˆ†æ”¯ã€‚</p><h3 id="rtos-k230ç¯å¢ƒé…ç½®"><a href="#rtos-k230ç¯å¢ƒé…ç½®" class="headerlink" title="rtos_k230ç¯å¢ƒé…ç½®"></a>rtos_k230ç¯å¢ƒé…ç½®</h3><p>rt-threadä»“åº“ä¸»è¦æ˜¯ç¼–è¯‘å†…æ ¸ï¼Œè¿˜éœ€è¦ç”¨å˜‰æ¥ çš„å·¥å…·åˆ¶ä½œä¸€ä¸ªsdå¡é•œåƒï¼š<a href="https://www.kendryte.com/k230_rtos/zh/dev/userguide/how_to_build.html">å¦‚ä½•ç¼–è¯‘å›ºä»¶</a> ä¸»è¦é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> dpkg --add-architecture i386<br><span class="hljs-built_in">sudo</span> apt update<br><br><span class="hljs-built_in">sudo</span> apt install -y --no-install-recommends \<br>    <span class="hljs-built_in">sudo</span> vim wget curl git git-lfs openssh-client net-tools sed tzdata expect \<br>    make cmake binutils build-essential gcc g++ bash patch perl tar cpio unzip \<br>    file bc bison flex autoconf automake python3 python3-pip python3-dev \<br>    lib32z1 libncurses5-dev fakeroot pigz tree doxygen gawk pkg-config \<br>    libssl-dev libc6-dev-i386 libncurses5:i386<br><br><span class="hljs-built_in">sudo</span> apt clean<br></code></pre></td></tr></table></figure><p>ä¸‹é¢pythonç¯å¢ƒé…ç½®æœ‰æ¦‚ç‡å‡ºç°ä¸€ä¸ªå‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">chuan@localhost:~/rtos_k230$ <span class="hljs-keyword">time</span> make <span class="hljs-built_in">log</span><br>Using prebuilt U-Boot binaries, skipping compilation<br>Adding Image /home/chuan/rtos_k230//output/k230_rtos_01studio_defconfig/uboot/u-boot.bin.gz<br>Image Name:   uboot<br>Created:      Sat Dec  6 22:42:03 2025<br>Image Type:   RISC-V U-Boot Firmware (gzip compressed)<br>Data Size:    300580 Bytes = 293.54 KiB = 0.29 MiB<br>Load Address: 80000000<br>Entry Point:  80000000<br>Convert U-Boot <span class="hljs-built_in">env</span> /home/chuan/rtos_k230/boards/k230_canmv_01studio/default.env =&gt; /home/chuan/rtos_k230/output/k230_rtos_01studio_defconfig/images/uboot/env.bin <span class="hljs-keyword">done</span>.<br>Generate U-Boot SPL Done.<br>Generating U-Boot binary with text base: 0x80000000<br>Generate U-Boot Done.<br>scons: Reading SConscript files ...<br>ImportError: cannot import name <span class="hljs-string">&#x27;mk_rtconfig&#x27;</span> from <span class="hljs-string">&#x27;menuconfig&#x27;</span> (/home/chuan/.local/lib/python3.10/site-packages/menuconfig.py):<br>  File <span class="hljs-string">&quot;/home/chuan/rtos_k230/src/rtsmart/rtsmart/kernel/bsp/maix3/SConstruct&quot;</span>, line 31:<br>    objs = PrepareBuilding(<span class="hljs-built_in">env</span>, RTT_ROOT, has_libcpu = True)<br>  File <span class="hljs-string">&quot;/home/chuan/rtos_k230/src/rtsmart/rtsmart/kernel/bsp/maix3/../../rt-thread/tools/building.py&quot;</span>, line 421:<br>    from menuconfig import mk_rtconfig<br>make[2]: *** [Makefile:26: .parse_config] Error 2<br>make[1]: *** [Makefile:84: rtsmart] Error 2<br><br>real    0m0.721s<br>user    0m0.220s<br>sys     0m0.096s<br></code></pre></td></tr></table></figure><p>å› ä¸º<code>rtos_k230</code>ç”¨çš„æ˜¯è‡ªå·±çš„<code>menuconfig</code>ï¼Œè€Œç³»ç»Ÿæœ¬èº«ç¯å¢ƒè‡ªå¸¦<code>menuconfig</code>ï¼Œè„šæœ¬æ‰¾ä¸åˆ°<code>mk_rtconfig</code>è¿™ä¸ªå‡½æ•°ï¼Œå› æ­¤å¼„ä¸€å¥—è™šæ‹Ÿç¯å¢ƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/rtos_k230<br>python3 -m venv .venv_rtos_k230<br><span class="hljs-built_in">source</span> .venv_rtos_k230/bin/activate<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨è¿™ä¸ªç¯å¢ƒä¸­å®‰è£…pythonç¯å¢ƒå³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip3 config <span class="hljs-built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple<br>pip3 install -U pyyaml pycryptodome gmssl<br></code></pre></td></tr></table></figure><p>repoå·¥å…·å®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p ~/.bin<br>curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/.bin/repo<br><span class="hljs-built_in">chmod</span> a+rx ~/.bin/repo<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;export PATH=&quot;$HOME/.bin:$PATH&quot;&#x27;</span> &gt;&gt; ~/.bashrc<br><span class="hljs-built_in">source</span> ~/.bashrc<br></code></pre></td></tr></table></figure><p>é…ç½®å¥½gitåï¼Œä¸‹è½½æºç ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºå·¥ä½œç›®å½•</span><br><span class="hljs-built_in">mkdir</span> -p ~/rtos_k230 &amp;&amp; <span class="hljs-built_in">cd</span> ~/rtos_k230<br><br><span class="hljs-comment"># ä» Gitee ä¸‹è½½ä»£ç ï¼ˆæ¨èå›½å†…ç”¨æˆ·ï¼Œéœ€é…ç½® SSH å¯†é’¥ï¼‰</span><br>repo init -u git@gitee.com:canmv-k230/manifest.git -m rtsmart.xml \<br>  --repo-url=git@gitee.com:canmv-k230/git-repo.git<br><br><span class="hljs-comment"># ä» GitHub ä¸‹è½½ä»£ç ï¼ˆå›½é™…ç”¨æˆ·ï¼‰</span><br><span class="hljs-comment"># repo init -u https://github.com/canmv-k230/manifest -m rtsmart.xml \</span><br><span class="hljs-comment">#   --repo-url=https://github.com/canmv-k230/git-repo.git</span><br><br><span class="hljs-comment"># åŒæ­¥ä»£ç ä»“åº“</span><br>repo <span class="hljs-built_in">sync</span> -j $(<span class="hljs-built_in">nproc</span>)<br></code></pre></td></tr></table></figure><h2 id="ç³»ç»Ÿç¼–è¯‘"><a href="#ç³»ç»Ÿç¼–è¯‘" class="headerlink" title="ç³»ç»Ÿç¼–è¯‘"></a>ç³»ç»Ÿç¼–è¯‘</h2><h3 id="åŸºç¡€é•œåƒç¼–è¯‘"><a href="#åŸºç¡€é•œåƒç¼–è¯‘" class="headerlink" title="åŸºç¡€é•œåƒç¼–è¯‘"></a>åŸºç¡€é•œåƒç¼–è¯‘</h3><p>æˆ‘ä»¬éœ€è¦ç”¨rtos_k230æ„å»ºå‡ºä¸€ä¸ªé•œåƒï¼ˆåªéœ€ä¸€æ¬¡å³å¯ï¼‰</p><p>cdè¿›æºç ç›®å½•ï¼Œé€‰æ‹©<code>01studio</code>çš„é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/rtos_k230<br>make list-def<br>make k230_rtos_01studio_defconfig<br></code></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">time</span> make <span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæ²¡é—®é¢˜ï¼Œä¼šç”Ÿæˆæ‰€éœ€é•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">TOC written at offset 0xe0000, size 448 bytes<br>Image sysimage-sdcard.img generated<br>All images generated successfully<br>Compress image RtSmart-K230_01Studio_rtsmart_local_nncase_v2.9.0.img.gz, it will take a <span class="hljs-keyword">while</span><br>Generated image <span class="hljs-keyword">done</span>, at /home/chuan/rtos_k230//output/k230_rtos_01studio_defconfig/RtSmart-K230_01Studio_rtsmart_local_nncase_v2.9.0.img<br>Build K230 <span class="hljs-keyword">done</span>, board k230_canmv_01studio, config k230_rtos_01studio_defconfig<br><br>real    0m34.594s<br>user    0m20.957s<br>sys     0m8.148s<br></code></pre></td></tr></table></figure><p><code>RtSmart-K230_01Studio_rtsmart_local_nncase_v2.9.0.img</code>è¿™ä¸ªå°±æ˜¯k230çš„é•œåƒæ–‡ä»¶ï¼Œæ‰¾ä¸ªsdå¡ç”¨balenaEtcheræˆ–è€…ç±»ä¼¼çš„å·¥å…·çƒ§è¿›å»å°±è¡Œäº†ã€‚</p><h3 id="å†…æ ¸ç¼–è¯‘"><a href="#å†…æ ¸ç¼–è¯‘" class="headerlink" title="å†…æ ¸ç¼–è¯‘"></a>å†…æ ¸ç¼–è¯‘</h3><p>ä¸‹é¢æ˜¯å†…æ ¸ç¼–è¯‘ï¼Œå…ˆcdè¿›æºç ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> rt-thread/bsp/k230<br></code></pre></td></tr></table></figure><p>é…ç½®<code>menuconfig</code>å¹¶ç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">scons --menuconfig<br>scons -j$(<span class="hljs-built_in">nproc</span>)<br></code></pre></td></tr></table></figure><p>ç›®å½•ä¸‹ä¼šç”Ÿæˆ<code>rtthread.bin</code>ï¼Œç„¶åç”¨è„šæœ¬å¯¹å…¶è¿›è¡Œæ‰“åŒ…å¹¶çƒ§å½•ï¼ˆè®°å¾—æ’å…¥sdå¡ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">./build.sh<br>./flashsd.sh <br></code></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>./flashsd.sh</code>æ—¶ï¼Œæœ‰å¯èƒ½ä¼šæç¤ºæ‰“ä¸å¼€SDå¡ï¼Œæˆ‘ä»¬æŸ¥çœ‹è¿™ä¸ªè„šæœ¬å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">source</span> ./utils.sh<br><br>BSP_PATH=$(<span class="hljs-built_in">realpath</span> $(<span class="hljs-built_in">dirname</span> <span class="hljs-variable">$0</span>))<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;BSP_PATH: <span class="hljs-variable">$BSP_PATH</span>&quot;</span><br><br>download_rttpkgtool <span class="hljs-variable">$BSP_PATH</span><br>result=$?<br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$result</span> -ne 0 ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ERROR: rttpkgtool is unavailable! Please check your network connection!&quot;</span><br><span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">pushd</span> <span class="hljs-variable">$BSP_PATH</span>/rttpkgtool &gt; /dev/null<br><br>./script/sdcard.sh &gt; /dev/null<br>result=$?<br><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$result</span> -eq 1 ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ERROR: The kernel file to be flashed does not exist!&quot;</span><br><span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$result</span> -eq 2 ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ERROR: The USB/SDcard does not exist!&quot;</span><br><span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;INFO: The kernel file has been flashed to the USB/SDcard successfully!&quot;</span><br><br><span class="hljs-built_in">popd</span> &gt; /dev/null<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šçƒ§å½•ç”¨çš„æ˜¯<code>rttpkgtool/script/sdcard.sh</code>è¿™ä¸ªè„šæœ¬ï¼Œæ‰“å¼€è¿™ä¸ªè„šæœ¬ï¼ŒæŠŠï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;DEST&#125;</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>        DEST=/dev/sde<br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><p>å°†è„šæœ¬ä¸­çš„<code>/dev/sde</code>æ”¹æˆsdå¡å®é™…æŒ‚è½½ä½ç½®å³å¯ã€‚</p><h3 id="WSL2å†…æ ¸ç¼–è¯‘"><a href="#WSL2å†…æ ¸ç¼–è¯‘" class="headerlink" title="WSL2å†…æ ¸ç¼–è¯‘"></a>WSL2å†…æ ¸ç¼–è¯‘</h3><p>wsl2è¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œwsl2æ²¡æ³•ç›´æ¥è®¿é—®ç‰©ç†æœºçš„å¤–éƒ¨è®¾å¤‡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©<code>usbipd</code>æŠŠWindowsçš„USBè®¾å¤‡é€šè¿‡ç½‘ç»œåˆ†äº«ç»™è™šæ‹Ÿæœºã€‚</p><p>windowså®‰è£…ï¼š<a href="https://github.com/dorssel/usbipd-win">usbipd-win</a>ï¼Œç”¨wingetæˆ–è€…msiå®‰è£…éƒ½è¡Œã€‚wsl2å†…æ ¸ç‰ˆæœ¬å¤Ÿæ–°è‡ªå¸¦<code>usbipd</code>ã€‚é™¤äº†è¿™ç©æ„ä»¥å¤–ï¼Œè¿˜éœ€è¦å•ç‹¬ç¼–ä¸€ä»½wsl2å†…æ ¸ï¼Œå› ä¸ºwsl2å†…æ ¸é»˜è®¤æ²¡å¼€å¯å¯¹å­˜å‚¨è®¾å¤‡çš„æ”¯æŒ</p><p>å…ˆgit cloneæºç ä¸‹æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/microsoft/WSL2-Linux-Kernel.git<br></code></pre></td></tr></table></figure><p>ç„¶åå®‰è£…ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt install libncurses-dev build-essential flex bison libssl-dev libelf-dev dwarves<br></code></pre></td></tr></table></figure><p>åœ¨<code>menuconfig</code>ä¸­å‹¾é€‰é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">make menuconfig KCONFIG_CONFIG=Microsoft/config-wsl<br></code></pre></td></tr></table></figure><p>ç„¶åå†<code>menuconfig</code>ä¸­æŠŠ<code>Device Drivers -&gt; USB support -&gt; USB Mass Storage support</code>ä¸‹é¢å…¨å‹¾ä¸Šå°±è¡Œäº†ï¼Œè®°å¾—æ‰“â€™*â€˜ç›´æ¥ç¼–è¯‘è¿›å†…æ ¸ï¼Œâ€˜Mâ€™éœ€è¦æ‰‹åŠ¨åŠ è½½</p><p><img src="/2025/12/12/K230-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/image-20251212195449342.png" alt="wsl2å†…æ ¸menuconfig"></p><p>ç„¶åç¼–è¯‘å†…æ ¸ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">make -j$(<span class="hljs-built_in">nproc</span>) bzImage KCONFIG_CONFIG=Microsoft/config-wsl<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ç»“æŸä¼šåœ¨<code>arch/x86/boot/</code>ä¸‹é¢ç”Ÿæˆåä¸º<code>bzImage</code>çš„å†…æ ¸æ–‡ä»¶ã€‚</p><p>æŠŠå†…æ ¸æ–‡ä»¶å¤åˆ¶å‡ºæ¥ï¼Œåœ¨<code>C:\Users\ç”¨æˆ·å</code>ç›®å½•ä¸‹çš„<code>.wslconfig</code>æ–‡ä»¶ä¸­åŠ å…¥ï¼ˆå¦‚æœä¸å­˜åœ¨å°±æ–°å»ºä¸€ä¸ªï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[wsl2]<br>processors=4<br>swapFile=E:\\WSL2_share<br>MaxCrashDumpCount=-1<br>kernel=E:\\wsl2_kernel\\bzImage<br></code></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦æ–°å»ºå°±åŠ ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œå°±è¡Œäº†ã€‚</p><p>å…·ä½“å¦‚ä½•å°†USBè®¾å¤‡å…±äº«ç»™WSL2ï¼Œå‚è€ƒå¾®è½¯æ–‡æ¡£ï¼š<a href="https://learn.microsoft.com/zh-cn/windows/wsl/connect-usb">è¿æ¥ USB è®¾å¤‡</a></p>]]></content>
    
    
    <categories>
      
      <category>K230-rt-smart</category>
      
    </categories>
    
    
    <tags>
      
      <tag>K230</tag>
      
      <tag>rt-smart</tag>
      
      <tag>åµŒå…¥å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
